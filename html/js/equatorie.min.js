(function(e,t,n){function r(n,i){if(!t[n]){if(!e[n]){var s=typeof require=="function"&&require;if(!i&&s)return s(n,!0);throw new Error("Cannot find module '"+n+"'")}var o=t[n]={exports:{}};e[n][0](function(t){var i=e[n][1][t];return r(i?i:t)},o,o.exports)}return t[n].exports}for(var i=0;i<n.length;i++)r(n[i]);return r})({1:[function(require,module,exports){(function(){var Equatorie,EquatorieInteract,EquatorieString,EquatorieSystem,cgl,eq,f,loadAssets,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};EquatorieSystem=require("./system").EquatorieSystem;EquatorieString=require("./string").EquatorieString;loadAssets=require("./load").loadAssets;EquatorieInteract=require("./interact").EquatorieInteract;Equatorie=function(){function Equatorie(){this.draw=__bind(this.draw,this);this.onPhysicsEvent=__bind(this.onPhysicsEvent,this);this.update=__bind(this.update,this);this.init=__bind(this.init,this)}Equatorie.prototype.init=function(){var cube,date,f,_this=this;this.top_node=new CoffeeGL.Node;this.string_height=.4;this.pickable=new CoffeeGL.Node;this.fbo_picking=new CoffeeGL.Fbo;this.ray=new CoffeeGL.Vec3(0,0,0);this.advance_date=0;this.basic_nodes=new CoffeeGL.Node;this.mp=new CoffeeGL.Vec2(-1,-1);this.system=new EquatorieSystem;this.ready=false;this.loaded=new CoffeeGL.Signal;f=function(){var q;console.log("Loaded Assets");_this.top_node.add(_this.basic_nodes);_this.basic_nodes.shader=_this.shader_basic;_this.marker.shader=_this.shader_basic;_this.top_node.add(_this.equatorie_model);_this.base=_this.equatorie_model.children[3];_this.epicycle=_this.equatorie_model.children[0];_this.pointer=_this.equatorie_model.children[4];_this.rim=_this.equatorie_model.children[2];_this.plate=_this.equatorie_model.children[1];_this.shiny=new CoffeeGL.Node;_this.equatorie_model.add(_this.shiny);_this.equatorie_model.remove(_this.epicycle);_this.equatorie_model.remove(_this.pointer);_this.equatorie_model.remove(_this.rim);_this.equatorie_model.remove(_this.plate);_this._setTangents(_this.pointer.geometry);_this._setTangents(_this.epicycle.geometry);_this._setTangents(_this.rim.geometry);_this._setTangents(_this.plate.geometry);_this.shiny.shader=_this.shader_aniso;_this.shiny.add(_this.epicycle);_this.shiny.add(_this.rim);_this.shiny.add(_this.plate);_this.pointer.add(_this.pointer_normal);_this.rim.add(_this.rim_normal);_this.plate.add(_this.plate_normal);_this.epicycle.add(_this.epicycle_normal);_this.shiny.uSamplerNormal=1;_this.base.shader=_this.shader;_this.base.uAmbientLightingColor=new CoffeeGL.Colour.RGBA(1,1,.8,1);_this.epicycle.uAmbientLightingColor=new CoffeeGL.Colour.RGBA(.1,.1,.1,1);_this.epicycle.uSpecColour=new CoffeeGL.Colour.RGBA(1,.9,.8,1);_this.epicycle.uAlphaX=.4;_this.epicycle.uAlphaY=.28;_this.pointer.uAmbientLightingColor=new CoffeeGL.Colour.RGBA(.1,.1,.1,1);_this.pointer.uSpecColour=new CoffeeGL.Colour.RGBA(1,.9,.9,1);_this.pointer.uAlphaX=.2;_this.pointer.uAlphaY=.1;_this.epicycle.uPickingColour=new CoffeeGL.Colour.RGBA(1,1,0,1);_this.pointer.uPickingColour=new CoffeeGL.Colour.RGBA(0,1,1,1);_this.pickable.add(_this.epicycle);_this.equatorie_model.remove(_this.pointer);_this.epicycle.add(_this.pointer);q=new CoffeeGL.Quaternion;q.fromAxisAngle(new CoffeeGL.Vec3(0,1,0),CoffeeGL.degToRad(-90));_this.base.matrix.mult(q.getMatrix4());_this.pickable.shader=_this.shader_picker;_this.top_node.add(_this.basic_nodes);_this.basic_nodes.shader=_this.shader_basic;_this.marker.shader=_this.shader_basic;_this.physics=new Worker("/js/physics.js");_this.physics.onmessage=_this.onPhysicsEvent;_this.physics.postMessage({cmd:"startup"});_this.interact=new EquatorieInteract(_this.system,_this.physics,_this.c,_this.white_start,_this.white_end,_this.black_start,_this.black_end,_this.epicycle,_this.pointer,_this.marker,_this.string_height);CoffeeGL.Context.mouseDown.add(_this.interact.onMouseDown,_this.interact);CoffeeGL.Context.mouseOver.add(_this.interact.onMouseOver,_this.interact);CoffeeGL.Context.mouseOut.add(_this.interact.onMouseOut,_this.interact);CoffeeGL.Context.mouseMove.add(_this.interact.onMouseMove,_this.interact);CoffeeGL.Context.mouseUp.add(_this.interact.onMouseUp,_this.interact);CoffeeGL.Context.mouseOver.add(_this.onMouseOver,_this);CoffeeGL.Context.mouseOut.add(_this.onMouseOut,_this);CoffeeGL.Context.mouseMove.add(_this.onMouseMove,_this);CoffeeGL.Context.mouseMove.del(_this.c.onMouseMove,_this.c);CoffeeGL.Context.mouseDown.del(_this.c.onMouseDown,_this.c);return _this.ready=true};this.loaded.addOnce(f,this);loadAssets(this,this.loaded);date=new Date;cube=new CoffeeGL.Shapes.Cuboid(new CoffeeGL.Vec3(.2,.2,.2));this.marker=new CoffeeGL.Node(cube);this.marker.uColour=new CoffeeGL.Colour.RGBA(0,1,1,1);this.top_node.add(this.marker);this.c=new CoffeeGL.Camera.TouchPerspCamera(new CoffeeGL.Vec3(0,0,25));this.top_node.add(this.c);this.pickable.add(this.c);this.light=new CoffeeGL.Light.PointLight(new CoffeeGL.Vec3(0,5,25),new CoffeeGL.Colour.RGB(1,1,1));this.light2=new CoffeeGL.Light.PointLight(new CoffeeGL.Vec3(0,15,5),new CoffeeGL.Colour.RGB(1,1,1));this.top_node.add(this.light);this.top_node.add(this.light2);GL.enable(GL.CULL_FACE);GL.cullFace(GL.BACK);GL.enable(GL.DEPTH_TEST);this.white_string=new EquatorieString(8,.08,20);this.black_string=new EquatorieString(8,.08,20);this.white_start=new CoffeeGL.Node(cube);this.pickable.add(this.white_start);this.white_start.matrix.translate(new CoffeeGL.Vec3(2,this.string_height,2));this.white_start.uPickingColour=new CoffeeGL.Colour.RGBA(1,0,0,1);this.white_end=new CoffeeGL.Node(cube);this.pickable.add(this.white_end);this.white_end.matrix.translate(new CoffeeGL.Vec3(-2,this.string_height,-2));this.white_end.uPickingColour=new CoffeeGL.Colour.RGBA(0,1,0,1);this.black_start=new CoffeeGL.Node(cube);this.pickable.add(this.black_start);this.black_start.matrix.translate(new CoffeeGL.Vec3(-2,this.string_height,2));this.black_start.uPickingColour=new CoffeeGL.Colour.RGBA(0,0,1,1);this.black_end=new CoffeeGL.Node(cube);this.pickable.add(this.black_end);this.black_end.matrix.translate(new CoffeeGL.Vec3(-4,this.string_height,2));this.black_end.uPickingColour=new CoffeeGL.Colour.RGBA(1,1,1,1);this.basic_nodes.add(this.white_string).add(this.black_string);this.basic_nodes.add(this.white_start).add(this.white_end);this.basic_nodes.add(this.black_start).add(this.black_end);this.white_string.uColour=new CoffeeGL.Colour.RGBA(.9,.9,.9,1);this.black_string.uColour=new CoffeeGL.Colour.RGBA(.1,.1,.1,1);this.white_start.uColour=new CoffeeGL.Colour.RGBA(.9,.2,.2,.8);return this.white_end.uColour=new CoffeeGL.Colour.RGBA(.9,.2,.2,.8)};Equatorie.prototype.update=function(dt){var date,m;if(!this.ready){return}date=new Date;this.angle=dt*.001*CoffeeGL.degToRad(20);if(this.angle>=CoffeeGL.PI*2){this.angle=0}m=new CoffeeGL.Quaternion;m.fromAxisAngle(new CoffeeGL.Vec3(0,1,0),this.angle);m.transVec3(this.light.pos);this.interact.update(dt);return this};Equatorie.prototype.updatePhysics=function(data){this.white_string.update(data.white);return this.black_string.update(data.black)};Equatorie.prototype.onPhysicsEvent=function(event){switch(event.data.cmd){case"physics":return this.updatePhysics(event.data.data);case"ping":return console.log("Physics Ping: "+event.data.data);default:break}};Equatorie.prototype.draw=function(){var pixel;GL.clearColor(.15,.15,.15,1);GL.clear(GL.COLOR_BUFFER_BIT|GL.DEPTH_BUFFER_BIT);this.c.update(CoffeeGL.Context.width,CoffeeGL.Context.height);if(this.top_node!=null){this.top_node.draw()}if(this.shader_picker!=null){this.fbo_picking.bind();this.fbo_picking.clear();this.shader_picker.bind();this.pickable.draw();if(this.mp.y!==-1&&this.mp.x!==-1){pixel=new Uint8Array(4);GL.readPixels(this.mp.x,this.fbo_picking.height-this.mp.y,1,1,GL.RGBA,GL.UNSIGNED_BYTE,pixel);this.interact.checkPicked(pixel)}this.shader_picker.unbind();return this.fbo_picking.unbind()}};Equatorie.prototype.onMouseMove=function(event){this.mp.x=event.mouseX;return this.mp.y=event.mouseY};Equatorie.prototype.onMouseOver=function(event){this.mp.x=event.mouseX;return this.mp.y=event.mouseY};Equatorie.prototype.onMouseOut=function(event){this.mp.x=-1;return this.mp.y=-1};Equatorie.prototype.resize=function(w,h){return this.fbo_picking.resize(w,h)};Equatorie.prototype._setTangents=function(geom){var a,b,c,face,_i,_len,_ref,_ref1;_ref=geom.faces;for(_i=0,_len=_ref.length;_i<_len;_i++){face=_ref[_i];_ref1=CoffeeGL.precomputeTangent(face.v[0].p,face.v[1].p,face.v[2].p,face.v[0].n,face.v[1].n,face.v[2].n,face.v[0].t,face.v[1].t,face.v[2].t),a=_ref1[0],b=_ref1[1],c=_ref1[2];face.v[0].tangent=a;face.v[1].tangent=b;face.v[2].tangent=c}return this};return Equatorie}();eq=new Equatorie;cgl=new CoffeeGL.App("webgl-canvas",eq,eq.init,eq.draw,eq.update);f=function(){var h,w;w=$(window).width();h=$(window).height();$("#webgl-canvas").attr("width",w);$("#webgl-canvas").attr("height",h);$("#webgl-canvas").width(w);$("#webgl-canvas").height(h);cgl.resize(w,h);return eq.resize(w,h)};$(window).bind("resize",f);$(window).bind("ready",f)}).call(this)},{"./system":2,"./string":3,"./load":4,"./interact":5}],2:[function(require,module,exports){(function(){var EquatorieSystem;EquatorieSystem=function(){function EquatorieSystem(){this.base_radius=6;this.epicycle_radius=6;this.epicycle_thickness=.333334;this.precession=3838e-8;this.planet_data={};this.planet_data.venus={deferent_speed:.98564734,epicycle_speed:.61652156,epicycle_ratio:.72294,deferent_eccentricity:.0145,apogee_longitude:98.1666667,mean_longitude:279.7,mean_anomaly:63.383};this.planet_data.mars={deferent_speed:.52407116,epicycle_speed:.46157618,epicycle_ratio:.6563,deferent_eccentricity:.10284,apogee_longitude:148.6166667,mean_longitude:293.55,mean_anomaly:346.15};this.planet_data.jupiter={deferent_speed:.08312944,epicycle_speed:.9025179,epicycle_ratio:.1922,deferent_eccentricity:.04817,apogee_longitude:188.9666667,mean_longitude:238.16666667,mean_anomaly:41.5333333};this.planet_data.saturn={deferent_speed:.03349795,epicycle_speed:.95214939,epicycle_ratio:.10483,deferent_eccentricity:.05318,apogee_longitude:270.76666667,mean_longitude:266.25,mean_anomaly:13.45};this.epoch=new Date("January 1, 1900 00:00:00");this.epoch_julian=2415020;this.reset()}EquatorieSystem.prototype.solveForPlanetDate=function(planet,date){this._setPlanet(planet);this._calculateDate(date);this._calculateDeferentAngle();this._calculateDeferentPosition();this._calculateEquantPosition();this._calculateMeanMotus();this._calculateParallel();this._calculateEpicyclePosition();this._calculatePointerAngle();this._calculatePointerPoint();return this._calculateTruePlace()};EquatorieSystem.prototype.reset=function(){return this.state={meanMotus:0,meanMotusPosition:0,deferentAngle:0,deferentPosition:0,passed:0,planet:"",date:0,parallelPosition:0,pointerAngle:0,equantPosition:0,epicycleRotation:0,epicyclePosition:0,epicyclePrePosition:0,basePosition:0,truePlace:0}};EquatorieSystem.prototype._setPlanet=function(planet){this.state.planet=planet;return this};EquatorieSystem.prototype._calculateDate=function(date){var a,j,m,p,y;a=(14-(date.getMonth()+1))/12;y=date.getFullYear()+4800-a;m=date.getMonth()+1+12*a-3;j=date.getDate()+(153*m+2)/5+365*y+y/4-y/100+y/400-32045;p=j-this.epoch_julian;this.state.passed=p;return p};EquatorieSystem.prototype._calculateDeferentAngle=function(){var angle,_ref;if((_ref=this.state.planet)==="mars"||_ref==="venus"||_ref==="jupiter"||_ref==="saturn"){angle=-this.planet_data[this.state.planet].apogee_longitude-this.precession*this.state.date;this.state.deferentAngle=angle;return angle}return this};EquatorieSystem.prototype._calculateDeferentPosition=function(){var x,y,_ref;if((_ref=this.state.planet)==="mars"||_ref==="venus"||_ref==="jupiter"||_ref==="saturn"){x=this.base_radius*this.planet_data[this.state.planet].deferent_eccentricity*Math.cos(CoffeeGL.degToRad(this.state.deferentAngle));y=this.base_radius*this.planet_data[this.state.planet].deferent_eccentricity*Math.sin(CoffeeGL.degToRad(this.state.deferentAngle));this.state.deferentPosition=new CoffeeGL.Vec2(x,y);return this.state.deferentPosition}return this};EquatorieSystem.prototype._calculateEquantPosition=function(){var _ref;if((_ref=this.state.planet)==="mars"||_ref==="venus"||_ref==="jupiter"||_ref==="saturn"){this.state.equantPosition=new CoffeeGL.Vec2(this.state.deferentPosition.x*2,this.state.deferentPosition.y*2);return this.state.equantPosition}};EquatorieSystem.prototype._calculateMeanMotus=function(){var mean_motus_angle,mean_motus_position,passed;passed=this.state.passed;mean_motus_angle=(this.planet_data[this.state.planet].mean_longitude+this.planet_data[this.state.planet].deferent_speed*passed)%360*-1;this.state.meanMotus=mean_motus_angle;mean_motus_position=new CoffeeGL.Vec2(this.base_radius*Math.cos(CoffeeGL.degToRad(mean_motus_angle)),this.base_radius*Math.sin(CoffeeGL.degToRad(mean_motus_angle)));this.state.meanMotusPosition=mean_motus_position;return[mean_motus_angle,mean_motus_position]};EquatorieSystem.prototype.rayCircleIntersection=function(ray_start,ray_dir,circle_centre,circle_radius){var a,b,c,d2,discriminant,f,r,t,t1,t2,v;f=CoffeeGL.Vec2.sub(ray_start,circle_centre);r=circle_radius;a=ray_dir.dot(ray_dir);b=2*f.dot(ray_dir);c=f.dot(f)-r*r;v=new CoffeeGL.Vec2;discriminant=b*b-4*a*c;if(discriminant!==0){discriminant=Math.sqrt(discriminant);t1=(-b-discriminant)/(2*a);t2=(-b+discriminant)/(2*a);t=t2;if(t2<0){t=t1}v.copyFrom(ray_start);d2=CoffeeGL.Vec2.multScalar(ray_dir,t);v.add(d2)}return v};EquatorieSystem.prototype._calculateParallel=function(){var base_position,cr,dangle,deferent_position,dir,equant_position,passed,sr;passed=this.state.passed;dangle=this.state.deferentAngle;cr=Math.cos(CoffeeGL.degToRad(dangle));sr=Math.sin(CoffeeGL.degToRad(dangle));base_position=new CoffeeGL.Vec2(this.base_radius*cr,this.base_radius*sr);this.state.basePosition=base_position;deferent_position=this.state.deferentPosition;equant_position=this.state.equantPosition;dir=this.state.meanMotusPosition.copy();dir.normalize();this.state.parallelPosition=this.rayCircleIntersection(equant_position,dir,deferent_position,this.base_radius);return this.state.parallelPosition};EquatorieSystem.prototype._calculateEpicyclePosition=function(){var dangle,deferent_position,equant_position,f0,f1,fangle,l,passed,v;passed=this.state.passed;dangle=this.state.deferentAngle;deferent_position=this.state.deferentPosition;equant_position=this.state.equantPosition;l=deferent_position.length()+this.epicycle_radius-this.epicycle_thickness;this.state.epicyclePrePosition=CoffeeGL.Vec2.normalize(deferent_position).multScalar(l);fangle=0;v=this.state.parallelPosition;if(v.x!==0&&v.y!==0){f0=CoffeeGL.radToDeg(Math.atan2(this.state.basePosition.y-deferent_position.y,this.state.basePosition.x-deferent_position.x));f1=CoffeeGL.radToDeg(Math.atan2(v.y-deferent_position.y,v.x-deferent_position.x));fangle=f0-f1}this.state.epicycleRotation=fangle;return[deferent_position,this.state.basePosition,v,dangle,fangle]};EquatorieSystem.prototype._calculatePointerAngle=function(){var aa,angle,ca,dv,epipos,pa,passed,pt0,pt1,sa;passed=this.state.passed;angle=this.planet_data[this.state.planet].mean_anomaly+this.planet_data[this.state.planet].epicycle_speed*passed;ca=Math.cos(CoffeeGL.degToRad(-this.state.epicycleRotation));sa=Math.sin(CoffeeGL.degToRad(-this.state.epicycleRotation));epipos=new CoffeeGL.Vec2(this.state.basePosition.x*ca-this.state.basePosition.y*sa,this.state.basePosition.x*sa+this.state.basePosition.y*ca);epipos.add(this.state.deferentPosition);this.state.epicyclePosition=epipos;pt0=CoffeeGL.Vec2.sub(this.state.meanMotusPosition,this.state.deferentPosition);pt1=CoffeeGL.Vec2.sub(epipos,this.state.deferentPosition);aa=CoffeeGL.radToDeg(Math.acos(CoffeeGL.Vec2.dot(CoffeeGL.Vec2.normalize(pt0),CoffeeGL.Vec2.normalize(pt1))));dv=CoffeeGL.Vec3.cross(new CoffeeGL.Vec3(0,1,0),new CoffeeGL.Vec3(pt0.x,0,pt0.y));if(dv.x>0){aa*=-1}pa=90-aa/2+angle;this.state.pointerAngle=pa;return pa};EquatorieSystem.prototype._calculatePointerPoint=function(){var angle,ca,deferent_position,dir,epipos,equant_position,fangle,motus_angle,motus_position,perp,sa;angle=this.state.pointerAngle;deferent_position=this.state.deferentPosition;motus_angle=this.state.meanMotus;motus_position=this.state.meanMotusPosition;equant_position=this.state.equantPosition;dir=motus_position.copy();dir.normalize();fangle=this.state.epicycleRotation;ca=Math.cos(CoffeeGL.degToRad(-fangle));sa=Math.sin(CoffeeGL.degToRad(-fangle));epipos=this.state.epicyclePosition;dir=CoffeeGL.Vec2.normalize(CoffeeGL.Vec2.sub(epipos,deferent_position));perp=dir.copy();perp.x=-dir.y;perp.y=dir.x;perp.multScalar(this.base_radius*this.planet_data[this.state.planet].epicycle_ratio);ca=Math.cos(CoffeeGL.degToRad(-angle));sa=Math.sin(CoffeeGL.degToRad(-angle));perp=new CoffeeGL.Vec2(perp.x*ca-perp.y*sa,perp.x*sa+perp.y*ca);perp.add(epipos);this.state.pointerPoint=perp;return perp};EquatorieSystem.prototype._calculateTruePlace=function(){var angle,dir,pp,xaxis;pp=this.state.pointerPoint;dir=CoffeeGL.Vec2.normalize(pp);xaxis=new CoffeeGL.Vec2(1,0);angle=CoffeeGL.radToDeg(Math.acos(xaxis.dot(dir)));this.state.truePlace=angle;return angle};return EquatorieSystem}();module.exports={EquatorieSystem:EquatorieSystem}}).call(this)},{}],3:[function(require,module,exports){(function(){var EquatorieString,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};EquatorieString=function(_super){__extends(EquatorieString,_super);function EquatorieString(length,thickness,segments){var i,seglength,segment_geom,segment_node,_i,_ref;EquatorieString.__super__.constructor.call(this);seglength=length/segments;segment_geom=new CoffeeGL.Shapes.Cylinder(thickness,12,seglength);for(i=_i=0,_ref=segments-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i){segment_node=new CoffeeGL.Node(segment_geom);this.add(segment_node)}}EquatorieString.prototype.update=function(data){var idx,phys,segment,tmatrix,tq,tv,_i,_len,_ref,_results;idx=0;_ref=this.children;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){segment=_ref[_i];phys=data.segments[idx];segment.matrix.identity();tq=new CoffeeGL.Quaternion;tv=new CoffeeGL.Vec3(phys.rax,phys.ray,phys.raz);tq.fromAxisAngle(tv,phys.ra);tmatrix=tq.getMatrix4();tmatrix.setPos(new CoffeeGL.Vec3(phys.x,phys.y,phys.z));segment.matrix.copyFrom(tmatrix);_results.push(idx++)}return _results};return EquatorieString}(CoffeeGL.Node);module.exports={EquatorieString:EquatorieString}}).call(this)},{}],4:[function(require,module,exports){(function(){var loadAssets,_loadAniso,_loadBasic,_loadEpicycleNormal,_loadLighting,_loadModel,_loadPicking,_loadPlateNormal,_loadPointerNormal,_loadRimNormal,_this=this;_loadLighting=function(obj,c){var r;r=new CoffeeGL.Request("../shaders/basic_lighting.glsl");return r.get(function(data){obj.shader=new CoffeeGL.Shader(data,{uAmbientLightingColor:"uAmbientLightingColor"});return c.test()})};_loadAniso=function(obj,c){var r;r=new CoffeeGL.Request("../shaders/anisotropic.glsl");return r.get(function(data){obj.shader_aniso=new CoffeeGL.Shader(data,{uAmbientLightingColor:"uAmbientLightingColor",uSpecColour:"uSpecColour",uSamplerNormal:"uSamplerNormal",uAlphaX:"uAlphaX",uAlphaY:"uAlphaY"});return c.test()})};_loadModel=function(obj,c){var r;r=new CoffeeGL.Request("../models/equatorie.js");return r.get(function(data){obj.equatorie_model=new CoffeeGL.JSONModel(data);return c.test()})};_loadBasic=function(obj,c){var r;r=new CoffeeGL.Request("../shaders/basic.glsl");return r.get(function(data){obj.shader_basic=new CoffeeGL.Shader(data,{uColour:"uColour"});return c.test()})};_loadPicking=function(obj,c){var r;r=new CoffeeGL.Request("../shaders/picking.glsl");return r.get(function(data){obj.shader_picker=new CoffeeGL.Shader(data,{uPickingColour:"uPickingColour"});return c.test()})};_loadEpicycleNormal=function(obj,c){return obj.epicycle_normal=new CoffeeGL.Texture("../models/epicycle_NRM.png",{unit:1},function(){return c.test()})};_loadPlateNormal=function(obj,c){return obj.plate_normal=new CoffeeGL.Texture("../models/plate_NRM.png",{unit:1},function(){return c.test()})};_loadRimNormal=function(obj,c){return obj.rim_normal=new CoffeeGL.Texture("../models/ring_NRM.png",{unit:1},function(){return c.test()})};_loadPointerNormal=function(obj,c){return obj.pointer_normal=new CoffeeGL.Texture("../models/label_NRM.png",{unit:1},function(){return c.test()})};loadAssets=function(obj,signal){var counter;counter={};counter.test=function(){this.count--;if(this.count<=0){return this.signal.dispatch()}};_loadLighting(obj,counter);_loadModel(obj,counter);_loadBasic(obj,counter);_loadPicking(obj,counter);_loadAniso(obj,counter);_loadEpicycleNormal(obj,counter);_loadPlateNormal(obj,counter);_loadRimNormal(obj,counter);_loadPointerNormal(obj,counter);counter.count=9;counter.signal=signal;return this};module.exports={loadAssets:loadAssets}}).call(this)},{}],5:[function(require,module,exports){(function(){var EquatorieInteract,EquatorieState,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};EquatorieState=function(){function EquatorieState(name,func,duration){this.name=name;this.func=func;this.duration=duration!=null?duration:3;if(this.duration==null){this.duration=3}}EquatorieState.prototype.update=function(dt){return this.func(dt)};return EquatorieState}();EquatorieInteract=function(){function EquatorieInteract(system,physics,camera,white_start,white_end,black_start,black_end,epicycle,pointer,marker,string_height){this.system=system;this.physics=physics;this.camera=camera;this.white_start=white_start;this.white_end=white_end;this.black_start=black_start;this.black_end=black_end;this.epicycle=epicycle;this.pointer=pointer;this.marker=marker;this.string_height=string_height;this._stateMoveBlackStringFinal=__bind(this._stateMoveBlackStringFinal,this);this._stateRotateLabel=__bind(this._stateRotateLabel,this);this._stateRotateEpicycle=__bind(this._stateRotateEpicycle,this);this._stateMoveEpicycle=__bind(this._stateMoveEpicycle,this);this._stateMoveWhiteThread=__bind(this._stateMoveWhiteThread,this);this._stateMoveBlackThread=__bind(this._stateMoveBlackThread,this);this._stateCalculateMeanMotus=__bind(this._stateCalculateMeanMotus,this);this._stateSetPlanetDate=__bind(this._stateSetPlanetDate,this);this.mp=new CoffeeGL.Vec2(-1,-1);this.mpp=new CoffeeGL.Vec2(-1,-1);this.mpd=new CoffeeGL.Vec2(0,0);this.picked=false;this.picked_item=void 0;this.dragging=false;this.advance_date=0;this.stack=[];this.stack_idx=0;this._initGUI();this.time={start:0,dt:0}}EquatorieInteract.prototype.update=function(dt){var da;if(this.stack.length>0){if(this.time.dt/1e3>this.stack[this.stack_idx].duration){this.stack[this.stack_idx].update(1);return}else if(this.time.dt<0){this.stack[this.stack_idx].update(0);return}else{da=this.time.dt/1e3/this.stack[this.stack_idx].duration;this.stack[this.stack_idx].update(da);this.time.dt+=dt}}return this.time.start=(new Date).getTime()};EquatorieInteract.prototype._stateSetPlanetDate=function(planet,date){return this.system.solveForPlanetDate(planet,date)};EquatorieInteract.prototype._stateCalculateMeanMotus=function(dt){return this};EquatorieInteract.prototype._stateMoveBlackThread=function(dt){var current_state,mv;current_state=this.stack[this.stack_idx];if(current_state.end_interp==null){mv=this.system.state.meanMotusPosition;mv.normalize();mv.multScalar(10);current_state.end_interp=new CoffeeGL.Interpolation(this.black_end.matrix.getPos(),new CoffeeGL.Vec3(mv.x,this.string_height,mv.y))}if(current_state.start_interp==null){current_state.start_interp=new CoffeeGL.Interpolation(this.black_start.matrix.getPos(),new CoffeeGL.Vec3(0,this.string_height,0))}this.black_start.matrix.setPos(current_state.start_interp.set(dt));this.black_end.matrix.setPos(current_state.end_interp.set(dt));this.physics.postMessage({cmd:"black_start_move",data:this.black_start.matrix.getPos()});this.physics.postMessage({cmd:"black_end_move",data:this.black_end.matrix.getPos()});return this};EquatorieInteract.prototype._stateMoveWhiteThread=function(dt){var current_state,eq,pv;current_state=this.stack[this.stack_idx];if(current_state.end_interp==null){eq=this.system.state.equantPosition;pv=this.system.state.parallelPosition;pv.sub(eq);pv.normalize();pv.multScalar(10);pv.add(eq);current_state.end_interp=new CoffeeGL.Interpolation(this.white_end.matrix.getPos(),new CoffeeGL.Vec3(pv.x,this.string_height,pv.y))}if(current_state.start_interp==null){eq=this.system.state.equantPosition;current_state.start_interp=new CoffeeGL.Interpolation(this.white_start.matrix.getPos(),new CoffeeGL.Vec3(eq.x,this.string_height,eq.y))}this.white_start.matrix.setPos(current_state.start_interp.set(dt));this.white_end.matrix.setPos(current_state.end_interp.set(dt));this.physics.postMessage({cmd:"white_start_move",data:this.white_start.matrix.getPos()});return this.physics.postMessage({cmd:"white_end_move",data:this.white_end.matrix.getPos()})};EquatorieInteract.prototype._stateMoveEpicycle=function(dt){var c,current_state,d,dr,e,v;current_state=this.stack[this.stack_idx];if(current_state.pos_interp==null){d=this.system.state.deferentPosition;c=this.system.state.basePosition;v=this.system.state.parallelPosition;dr=this.system.state.deferentAngle;e=this.system.state.epicyclePrePosition;current_state.pos_interp=new CoffeeGL.Interpolation(this.epicycle.matrix.getPos(),new CoffeeGL.Vec3(e.x,0,e.y))}this.epicycle.matrix.identity();return this.epicycle.matrix.translate(current_state.pos_interp.set(dt))};EquatorieInteract.prototype._stateRotateEpicycle=function(dt){};EquatorieInteract.prototype._stateRotateLabel=function(dt){var cp,pangle;pangle=this.system.state.pointerAngle;this.pointer.matrix.identity();this.pointer.matrix.rotate(new CoffeeGL.Vec3(0,1,0),CoffeeGL.degToRad(pangle));cp=this.system.state.pointerPoint;this.marker.matrix.identity();return this.marker.matrix.translate(new CoffeeGL.Vec3(cp.x,.6,cp.y))};EquatorieInteract.prototype._stateMoveBlackStringFinal=function(dt){};EquatorieInteract.prototype.addStates=function(planet,date){var _this=this;if(planet==="mars"||planet==="venus"||planet==="jupiter"||planet==="saturn"){this.stack=[];this.stack.push(new EquatorieState("Select Date and Planet",function(){return function(planet,date){return _this._stateSetPlanetDate(planet,date)}(planet,date)}));this.stack.push(new EquatorieState("Calculate Mean Motus",this._stateCalculateMeanMotus));this.stack.push(new EquatorieState("Move Black Thread",this._stateMoveBlackThread));this.stack.push(new EquatorieState("Move White Thread",this._stateMoveWhiteThread));this.stack.push(new EquatorieState("Move Epicycle",this._stateMoveEpicycle));return this.stack.push(new EquatorieState("Rotate Label",this._stateRotateLabel))}};EquatorieInteract.prototype.reset=function(){this.stack=[];return this.stack_idx=0};EquatorieInteract.prototype.solveForPlanet=function(planet,date){var state,_i,_len,_ref,_results;this.stack=[];this.stack_idx=0;this.addStates(planet,date);_ref=this.stack;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){state=_ref[_i];_results.push(state.update(1))}return _results};EquatorieInteract.prototype.onMouseDown=function(event){console.log(event);this.mp.x=event.mouseX;this.mp.y=event.mouseY;this.ray=this.camera.castRay(this.mp.x,this.mp.y);this.mdown=true;if(!this.picked){return this.camera.onMouseDown(event)}else{return this.dragging=true}};EquatorieInteract.prototype.onMouseMove=function(event){var d,dd,np,p0,p1,tp,tray;this.mpp.x=this.mp.x;this.mpp.y=this.mp.y;this.mp.x=event.mouseX;this.mp.y=event.mouseY;this.mpd.x=this.mp.x-this.mpp.x;this.mpd.y=this.mp.y-this.mpp.y;if(this.dragging){tray=this.camera.castRay(this.mp.x,this.mp.y);d=CoffeeGL.rayPlaneIntersect(new CoffeeGL.Vec3(0,this.string_height,0),new CoffeeGL.Vec3(0,1,0),this.camera.pos,this.ray);dd=CoffeeGL.rayPlaneIntersect(new CoffeeGL.Vec3(0,this.string_height,0),new CoffeeGL.Vec3(0,1,0),this.camera.pos,tray);p0=tray.copy();p0.multScalar(dd);p0.add(this.camera.pos);p1=this.ray.copy();p1.multScalar(d);p1.add(this.camera.pos);p0.y=this.string_height;p1.y=this.string_height;np=CoffeeGL.Vec3.sub(p0,p1);this.ray.copyFrom(tray);if(this.picked_item!==this.pointer){tp=this.picked_item.matrix.getPos();this.picked_item.matrix.setPos(tp.add(np))}if(this.picked_item===this.white_start){return this.physics.postMessage({cmd:"white_start_move",data:this.picked_item.matrix.getPos()})}else if(this.picked_item===this.white_end){return this.physics.postMessage({cmd:"white_end_move",data:this.picked_item.matrix.getPos()})}else if(this.picked_item===this.black_start){return this.physics.postMessage({cmd:"black_start_move",data:this.picked_item.matrix.getPos()})}else if(this.picked_item===this.black_end){return this.physics.postMessage({cmd:"black_end_move",data:this.picked_item.matrix.getPos()})}}else{return this.camera.onMouseMove(event)}};EquatorieInteract.prototype.checkPicked=function(p){if(this.dragging){return}this.picked=false;if(p[0]===255&&p[1]===0&&p[2]===0){this.picked_item=this.white_start;return this.picked=true}else if(p[0]===0&&p[1]===255&&p[2]===0){this.picked_item=this.white_end;return this.picked=true}else if(p[0]===0&&p[1]===0&&p[2]===255){this.picked_item=this.black_start;return this.picked=true}else if(p[0]===255&&p[1]===255&&p[2]===255){this.picked_item=this.black_end;return this.picked=true}else if(p[0]===255&&p[1]===255&&p[2]===0){this.picked_item=this.epicycle;return this.picked=true}else if(p[0]===0&&p[1]===255&&p[2]===255){this.picked_item=this.pointer;return this.picked=true}};EquatorieInteract.prototype._initGUI=function(){var controller,planets,_this=this;this.datgui=new dat.GUI;this.datgui.remember(this);planets=["mars","venus","jupiter","saturn"];this.chosen_planet="mars";controller=this.datgui.add(this,"chosen_planet",planets);controller=this.datgui.add(this,"solveForCurrentDatePlanet");controller=this.datgui.add(this,"advance_date",0,730);controller.onChange(function(value){return _this.solveForCurrentDatePlanet()});controller=this.datgui.add(this,"stepForward");controller=this.datgui.add(this.pointer,"uAlphaX",0,1);controller=this.datgui.add(this.pointer,"uAlphaY",0,1);controller=this.datgui.add(this.epicycle,"uAlphaX",0,1);return controller=this.datgui.add(this.epicycle,"uAlphaY",0,1)};EquatorieInteract.prototype.solveForCurrentDatePlanet=function(){var date;date=new Date;date.setDate(date.getDate()+this.advance_date);return this.solveForPlanet(this.chosen_planet,date)};EquatorieInteract.prototype.stepForward=function(){this.time.start=(new Date).getTime();if(this.stack.length===0){this.addStates(this.chosen_planet,new Date);return this.stack_idx=0}else{if(this.stack_idx+1<this.stack.length){this.stack[this.stack_idx].update(1);this.time.dt=0;return this.stack_idx+=1}}};EquatorieInteract.prototype.onMouseOver=function(event){this.mp.x=event.mouseX;return this.mp.y=event.mouseY};EquatorieInteract.prototype.onMouseUp=function(event){this.mdown=false;this.picked=false;return this.dragging=false};EquatorieInteract.prototype.onMouseOut=function(event){this.mp.x=this.mpp.x=-1;this.mp.y=this.mpp.y=-1;this.mpd.x=this.mpd.y=0;this.mdown=false;this.picked=false;return this.dragging=false};return EquatorieInteract}();module.exports={EquatorieInteract:EquatorieInteract}}).call(this)},{}]},{},[1]);