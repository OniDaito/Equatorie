(function(e,t,n){function r(n,i){if(!t[n]){if(!e[n]){var s=typeof require=="function"&&require;if(!i&&s)return s(n,!0);throw new Error("Cannot find module '"+n+"'")}var o=t[n]={exports:{}};e[n][0](function(t){var i=e[n][1][t];return r(i?i:t)},o,o.exports)}return t[n].exports}for(var i=0;i<n.length;i++)r(n[i]);return r})({1:[function(require,module,exports){(function(){var Equatorie,EquatorieInteract,EquatorieString,EquatorieSystem,cgl,eq,f,loadAssets,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};EquatorieSystem=require("./system").EquatorieSystem;EquatorieString=require("./string").EquatorieString;loadAssets=require("./load").loadAssets;EquatorieInteract=require("./interact").EquatorieInteract;Equatorie=function(){function Equatorie(){this.draw=__bind(this.draw,this);this.onPhysicsEvent=__bind(this.onPhysicsEvent,this);this.update=__bind(this.update,this);this.init=__bind(this.init,this)}Equatorie.prototype.init=function(){var cube,cube_thin,date,f,sphere,_this=this;this.top_node=new CoffeeGL.Node;this.string_height=.4;this.string_nodes=new CoffeeGL.Node;this.pickable=new CoffeeGL.Node;this.fbo_picking=new CoffeeGL.Fbo;this.ray=new CoffeeGL.Vec3(0,0,0);this.fbo_fxaa=new CoffeeGL.Fbo;this.advance_date=0;this.basic_nodes=new CoffeeGL.Node;this.mp=new CoffeeGL.Vec2(-1,-1);this.system=new EquatorieSystem;this.ready=false;this.loaded=new CoffeeGL.Signal;this.load_progress=new CoffeeGL.Signal;if(typeof window!=="undefined"&&window!==null){window.EquatorieLoaded=this.loaded}if(typeof window!=="undefined"&&window!==null){window.EquatorieLoadProgress=this.load_progress}this.system._calculateDate(new Date("January 1, 1393 00:00:00"));this.system._setPlanet("mars");this.system._calculateDeferentAngle();this.system._setPlanet("venus");this.system._calculateDeferentAngle();this.system._setPlanet("jupiter");this.system._calculateDeferentAngle();this.system._setPlanet("saturn");this.system._calculateDeferentAngle();this.system._setPlanet("mercury");this.system._calculateDeferentAngle();this.system._calculateDeferentPosition();this.system.reset();f=function(){var q;_this.top_node.add(_this.basic_nodes);_this.basic_nodes.shader=_this.shader_basic;_this.marker.shader=_this.shader_basic;_this.backing=new CoffeeGL.Node(new CoffeeGL.Quad);_this.backing.shader=_this.shader_background;_this.top_node.add(_this.equatorie_model);_this.string_nodes.shader=_this.shader_string;_this.top_node.add(_this.string_nodes);_this.base=_this.equatorie_model.children[4];_this.epicycle=_this.equatorie_model.children[1];_this.pointer=_this.equatorie_model.children[0];_this.rim=_this.equatorie_model.children[3];_this.plate=_this.equatorie_model.children[2];_this.shiny=new CoffeeGL.Node;_this.equatorie_model.add(_this.shiny);_this.equatorie_model.remove(_this.epicycle);_this.equatorie_model.remove(_this.pointer);_this.equatorie_model.remove(_this.rim);_this.equatorie_model.remove(_this.plate);_this.equatorie_model.remove(_this.base);_this._setTangents(_this.pointer.geometry);_this._setTangents(_this.epicycle.geometry);_this._setTangents(_this.rim.geometry);_this._setTangents(_this.plate.geometry);_this._setTangents(_this.base.geometry);_this.shiny.shader=_this.shader_aniso;_this.shiny.add(_this.epicycle);_this.shiny.add(_this.rim);_this.shiny.add(_this.plate);_this.shiny.add(_this.base);_this.pointer.add(_this.pointer_normal);_this.rim.add(_this.rim_normal);_this.plate.add(_this.plate_normal);_this.epicycle.add(_this.epicycle_normal);_this.base.add(_this.base_normal);_this.shiny.uSamplerNormal=1;_this.base.uAmbientLightingColor=new CoffeeGL.Colour.RGBA(1,1,.8,1);_this.base.uSpecColour=new CoffeeGL.Colour.RGBA(.5,.5,.5,1);_this.base.uAlphaX=.05;_this.base.uAlphaY=.05;_this.epicycle.uAmbientLightingColor=new CoffeeGL.Colour.RGBA(.1,.1,.1,1);_this.epicycle.uSpecColour=new CoffeeGL.Colour.RGBA(1,.9,.8,1);_this.epicycle.uAlphaX=.4;_this.epicycle.uAlphaY=.28;_this.pointer.uAmbientLightingColor=new CoffeeGL.Colour.RGBA(.1,.1,.1,1);_this.pointer.uSpecColour=new CoffeeGL.Colour.RGBA(1,.9,.9,1);_this.pointer.uAlphaX=.2;_this.pointer.uAlphaY=.1;_this.epicycle.uPickingColour=new CoffeeGL.Colour.RGBA(1,1,0,1);_this.pointer.uPickingColour=new CoffeeGL.Colour.RGBA(0,1,1,1);_this.pickable.add(_this.epicycle);_this.equatorie_model.remove(_this.pointer);_this.epicycle.add(_this.pointer);q=new CoffeeGL.Quaternion;q.fromAxisAngle(new CoffeeGL.Vec3(0,1,0),CoffeeGL.degToRad(-90));_this.base.matrix.mult(q.getMatrix4());_this.pickable.shader=_this.shader_picker;_this.top_node.add(_this.basic_nodes);_this.basic_nodes.shader=_this.shader_basic;_this.marker.shader=_this.shader_basic;_this.physics=new Worker("/js/physics.js");_this.physics.onmessage=_this.onPhysicsEvent;_this.physics.postMessage({cmd:"startup"});_this.interact=new EquatorieInteract(_this.system,_this.physics,_this.c,_this.white_start,_this.white_end,_this.black_start,_this.black_end,_this.epicycle,_this.pointer,_this.marker,_this.string_height);if(typeof window!=="undefined"&&window!==null){window.Equatorie=eq.interact}CoffeeGL.Context.mouseDown.add(_this.interact.onMouseDown,_this.interact);CoffeeGL.Context.mouseOver.add(_this.interact.onMouseOver,_this.interact);CoffeeGL.Context.mouseOut.add(_this.interact.onMouseOut,_this.interact);CoffeeGL.Context.mouseMove.add(_this.interact.onMouseMove,_this.interact);CoffeeGL.Context.mouseUp.add(_this.interact.onMouseUp,_this.interact);CoffeeGL.Context.mouseOver.add(_this.onMouseOver,_this);CoffeeGL.Context.mouseOut.add(_this.onMouseOut,_this);CoffeeGL.Context.mouseMove.add(_this.onMouseMove,_this);CoffeeGL.Context.mouseMove.del(_this.c.onMouseMove,_this.c);CoffeeGL.Context.mouseDown.del(_this.c.onMouseDown,_this.c);_this.screen_quad=new CoffeeGL.Node(new CoffeeGL.Quad);_this.screen_quad.viewportSize=new CoffeeGL.Vec2(CoffeeGL.Context.width,CoffeeGL.Context.height);_this.screen_quad.add(_this.shader_fxaa);return _this.ready=true};this.loaded.addOnce(f,this);loadAssets(this,this.loaded,this.load_progress);date=new Date;cube=new CoffeeGL.Shapes.Cuboid(new CoffeeGL.Vec3(.2,.2,.2));sphere=new CoffeeGL.Node(new CoffeeGL.Shapes.Sphere(.1,12));cube_thin=new CoffeeGL.Node(new CoffeeGL.Shapes.Cuboid(new CoffeeGL.Vec3(.01,.5,.01)));cube_thin.matrix.translate(new CoffeeGL.Vec3(0,-.2,0));sphere.matrix.translate(new CoffeeGL.Vec3(0,.1,0));this.pin=new CoffeeGL.Node;this.pin.add(sphere);this.pin.add(cube_thin);this.marker=this.pin.copy();this.marker.uColour=new CoffeeGL.Colour.RGBA(0,1,1,1);this.top_node.add(this.marker);this.c=new CoffeeGL.Camera.TouchPerspCamera(new CoffeeGL.Vec3(0,0,10));this.c.rotateFocal(new CoffeeGL.Vec3(1,0,0),CoffeeGL.degToRad(-25));this.top_node.add(this.c);this.pickable.add(this.c);this.light=new CoffeeGL.Light.PointLight(new CoffeeGL.Vec3(0,5,25),new CoffeeGL.Colour.RGB(1,1,1));this.light2=new CoffeeGL.Light.PointLight(new CoffeeGL.Vec3(0,15,5),new CoffeeGL.Colour.RGB(1,1,1));this.top_node.add(this.light);this.top_node.add(this.light2);GL.enable(GL.CULL_FACE);GL.cullFace(GL.BACK);GL.enable(GL.DEPTH_TEST);this.white_string=new EquatorieString(10,.015,20);this.black_string=new EquatorieString(10,.015,20);this.white_start=this.pin.copy();this.pickable.add(this.white_start);this.white_start.matrix.translate(new CoffeeGL.Vec3(2,this.string_height,2));this.white_start.uPickingColour=new CoffeeGL.Colour.RGBA(1,0,0,1);this.white_end=this.pin.copy();this.pickable.add(this.white_end);this.white_end.matrix.translate(new CoffeeGL.Vec3(-2,this.string_height,-2));this.white_end.uPickingColour=new CoffeeGL.Colour.RGBA(0,1,0,1);this.black_start=this.pin.copy();this.pickable.add(this.black_start);this.black_start.matrix.translate(new CoffeeGL.Vec3(-2,this.string_height,2));this.black_start.uPickingColour=new CoffeeGL.Colour.RGBA(0,0,1,1);this.black_end=this.pin.copy();this.pickable.add(this.black_end);this.black_end.matrix.translate(new CoffeeGL.Vec3(-4,this.string_height,2));this.black_end.uPickingColour=new CoffeeGL.Colour.RGBA(1,1,1,1);this.string_nodes.add(this.white_string).add(this.black_string);this.basic_nodes.add(this.white_start).add(this.white_end);this.basic_nodes.add(this.black_start).add(this.black_end);this.white_string.uColour=new CoffeeGL.Colour.RGBA(.9,.9,.9,1);this.black_string.uColour=new CoffeeGL.Colour.RGBA(.1,.1,.1,1);this.white_start.uColour=new CoffeeGL.Colour.RGBA(.9,.2,.2,.8);this.white_end.uColour=new CoffeeGL.Colour.RGBA(.2,.2,.9,.8);this.black_start.uColour=new CoffeeGL.Colour.RGBA(.9,.2,.2,.8);return this.black_end.uColour=new CoffeeGL.Colour.RGBA(.2,.2,.9,.8)};Equatorie.prototype.update=function(dt){var date,m;if(!this.ready){return}date=new Date;this.angle=dt*.001*CoffeeGL.degToRad(20);if(this.angle>=CoffeeGL.PI*2){this.angle=0}m=new CoffeeGL.Quaternion;m.fromAxisAngle(new CoffeeGL.Vec3(0,1,0),this.angle);m.transVec3(this.light.pos);this.interact.update(dt);return this};Equatorie.prototype.updatePhysics=function(data){this.white_string.update(data.white);return this.black_string.update(data.black)};Equatorie.prototype.onPhysicsEvent=function(event){switch(event.data.cmd){case"physics":return this.updatePhysics(event.data.data);case"ping":return console.log("Physics Ping: "+event.data.data);default:break}};Equatorie.prototype.draw=function(){var pixel;GL.clearColor(.15,.15,.15,1);GL.clear(GL.COLOR_BUFFER_BIT|GL.DEPTH_BUFFER_BIT);this.c.update(CoffeeGL.Context.width,CoffeeGL.Context.height);if(!this.ready){return}this.fbo_fxaa.bind();this.fbo_fxaa.clear();GL.disable(GL.DEPTH_TEST);this.backing.draw();GL.enable(GL.DEPTH_TEST);this.top_node.draw();this.fbo_fxaa.unbind();if(this.shader_picker!=null){this.fbo_picking.bind();this.fbo_picking.clear();this.shader_picker.bind();this.pickable.draw();if(this.mp.y!==-1&&this.mp.x!==-1){pixel=new Uint8Array(4);GL.readPixels(this.mp.x,this.fbo_picking.height-this.mp.y,1,1,GL.RGBA,GL.UNSIGNED_BYTE,pixel);this.interact.checkPicked(pixel)}this.shader_picker.unbind();this.fbo_picking.unbind()}GL.disable(GL.DEPTH_TEST);this.fbo_fxaa.texture.bind();this.screen_quad.draw();this.fbo_fxaa.texture.unbind();return GL.enable(GL.DEPTH_TEST)};Equatorie.prototype.onMouseMove=function(event){this.mp.x=event.mouseX;return this.mp.y=event.mouseY};Equatorie.prototype.onMouseOver=function(event){this.mp.x=event.mouseX;return this.mp.y=event.mouseY};Equatorie.prototype.onMouseOut=function(event){this.mp.x=-1;return this.mp.y=-1};Equatorie.prototype.resize=function(w,h){this.fbo_picking.resize(w,h);this.fbo_fxaa.resize(w,h);if(this.screen_quad!=null){this.screen_quad.viewportSize.x=w;return this.screen_quad.viewportSize.y=h}};Equatorie.prototype._setTangents=function(geom){var a,b,c,face,_i,_len,_ref,_ref1;_ref=geom.faces;for(_i=0,_len=_ref.length;_i<_len;_i++){face=_ref[_i];_ref1=CoffeeGL.precomputeTangent(face.v[0].p,face.v[1].p,face.v[2].p,face.v[0].n,face.v[1].n,face.v[2].n,face.v[0].t,face.v[1].t,face.v[2].t),a=_ref1[0],b=_ref1[1],c=_ref1[2];face.v[0].tangent=a;face.v[1].tangent=b;face.v[2].tangent=c}return this};return Equatorie}();eq=new Equatorie;cgl=new CoffeeGL.App("webgl-canvas",eq,eq.init,eq.draw,eq.update);f=function(){var h,w;w=$(window).width();h=$(window).height();$("#webgl-canvas").attr("width",w);$("#webgl-canvas").attr("height",h);$("#webgl-canvas").width(w);$("#webgl-canvas").height(h);cgl.resize(w,h);return eq.resize(w,h)};$(window).bind("resize",f);$(window).bind("ready",f)}).call(this)},{"./system":2,"./string":3,"./load":4,"./interact":5}],2:[function(require,module,exports){(function(){var EquatorieSystem;EquatorieSystem=function(){function EquatorieSystem(){this.base_radius=6;this.inch_to_base=.166666666667;this.epicycle_radius=6;this.epicycle_thickness=.333334;this.precession=0;this.moon_radius=1.17742;this.planet_data={};this.planet_data.venus={deferent_speed:.9856464,epicycle_speed:.61652156,epicycle_ratio:.76639,deferent_eccentricity:.018056,apogee_longitude:90.15,mean_longitude:288.55,mean_anomaly:23.216667};this.planet_data.mars={deferent_speed:.52406791,epicycle_speed:.46157618,epicycle_ratio:.68611,deferent_eccentricity:.095,apogee_longitude:133.93333,mean_longitude:92.2,mean_anomaly:196.33333};this.planet_data.jupiter={deferent_speed:.08312709,epicycle_speed:.9025179,epicycle_ratio:.184167,deferent_eccentricity:.049583,apogee_longitude:172.333,mean_longitude:324.75,mean_anomaly:323.78333};this.planet_data.saturn={deferent_speed:.03349673,epicycle_speed:.95214939,epicycle_ratio:.10361,deferent_eccentricity:.0543056,apogee_longitude:252.11666667,mean_longitude:184.75,mean_anomaly:103.78333};this.planet_data.mercury={deferent_speed:.9856464,epicycle_speed:3.10670237,epicycle_ratio:.36722,deferent_eccentricity:.05056,apogee_longitude:209.7666666,mean_longitude:288.55,mean_anomaly:259.78333};this.planet_data.sun={deferent_speed:.9856464,apogee_longitude:90.15,mean_longitude:288.55,equant_ratio:1/32};this.planet_data.moon={deferent_speed:13.1763947,epicycle_speed:13.0649885,epicycle_ratio:.08694,mean_longitude:130.46666,mean_anomaly:84.63333};this.planet_data.moon_latitude=this.planet_data.moon;this.planet_data.caput_draconis={start_motus:15.35,speed:.05295426};this.epoch=new Date("January 1, 1393 00:00:00");this.epoch_julian=2229851.5;this.reset()}EquatorieSystem.prototype.solveForPlanetDate=function(planet,date){var _ref;this._setPlanet(planet);this._calculateDate(date);_ref=this._calculateMeanMotusBody("sun"),this.state.sunMeanMotus=_ref[0],this.state.sunMeanMotusPosition=_ref[1];if(planet==="mercury"||planet==="venus"||planet==="mars"||planet==="jupiter"||planet==="saturn"){this._calculateDeferentAngle();this._calculateMeanMotus();this._calculateDeferentPosition();this._calculateEquantPosition();this._calculateParallel();this._calculateEpicyclePosition();this._calculatePointerAngle();this._calculatePointerPoint();return this._calculateTruePlace()}else if(planet==="sun"){this._calculateEquantPosition();this._calculateMeanMotus();this._calculateParallel();return this._calculateSunCrossingPoint()}else if(planet==="moon"||planet==="moon_latitude"){this._calculateMeanMotus();this._calculateDeferentAngle();this._calculateDeferentPosition();this._calculateEquantPosition();this._calculateEpicyclePosition();this._calculateMoonEquations();this._calculatePointerAngle();return this._calculatePointerPoint()}};EquatorieSystem.prototype.reset=function(){return this.state={meanMotus:0,sunMeanMotus:0,meanMotusPosition:0,sunMeanMotusPosition:0,deferentAngle:0,deferentPosition:0,mercuryDeferentAngle:0,sunCirclePoint:0,passed:0,planet:"",date:0,parallelPosition:0,pointerAngle:0,pointerPoint:0,equantPosition:0,epicycleRotation:0,epicyclePosition:0,epicyclePrePosition:0,basePosition:0,truePlace:0,meanAux:0,mercuryDeferentPosition:0,moonEquationCentre:0,moonTrueMotus:0,caputDraconisMotus:0,moonLatitudeDegree:0,moonLatitudeLeft:0,moonLatitudeRight:0}};EquatorieSystem.prototype._setPlanet=function(planet){this.state.planet=planet;return this};EquatorieSystem.prototype._calculateDate=function(date){var a,j,m,p,y;a=(14-(date.getMonth()+1))/12;y=date.getFullYear()+4800-a;m=date.getMonth()+1+12*a-3;j=date.getDate()+(153*m+2)/5+365*y+y/4-y/100+y/400-32045;p=j-this.epoch_julian;this.state.passed=p;return p};EquatorieSystem.prototype._calculateDeferentAngle=function(){var angle,_ref,_ref1;if((_ref=this.state.planet)==="mars"||_ref==="venus"||_ref==="jupiter"||_ref==="saturn"||_ref==="mercury"){angle=-this.planet_data[this.state.planet].apogee_longitude-this.precession*this.state.date;this.state.deferentAngle=angle;return angle}else if((_ref1=this.state.planet)==="moon"||_ref1==="moon_latitude"){this.state.deferentAngle=this.state.meanMotus+Math.abs(this.state.meanMotus-this.state.sunMeanMotus);return this.state.deferentAngle}return this};EquatorieSystem.prototype._calculateDeferentPosition=function(){var base_position,cr,da,l,md,meanCentre,offset,sr,x,xa,y,_ref,_ref1;if((_ref=this.state.planet)==="mars"||_ref==="venus"||_ref==="jupiter"||_ref==="saturn"){x=this.inch_to_base*34*this.planet_data[this.state.planet].deferent_eccentricity*Math.cos(CoffeeGL.degToRad(this.state.deferentAngle));y=this.inch_to_base*34*this.planet_data[this.state.planet].deferent_eccentricity*Math.sin(CoffeeGL.degToRad(this.state.deferentAngle));this.state.deferentPosition=new CoffeeGL.Vec2(x,y);cr=Math.cos(CoffeeGL.degToRad(this.state.deferentAngle));sr=Math.sin(CoffeeGL.degToRad(this.state.deferentAngle));this.state.basePosition=new CoffeeGL.Vec2(this.base_radius*cr,this.base_radius*sr);return this.state.deferentPosition}else if(this.state.planet==="mercury"){x=this.inch_to_base*34*this.planet_data[this.state.planet].deferent_eccentricity*Math.cos(CoffeeGL.degToRad(this.state.deferentAngle));y=this.inch_to_base*34*this.planet_data[this.state.planet].deferent_eccentricity*Math.sin(CoffeeGL.degToRad(this.state.deferentAngle));this.state.deferentPosition=new CoffeeGL.Vec2(x,y);meanCentre=this.state.deferentAngle+this.state.meanMotus*-1;l=this.state.deferentPosition.length();x=Math.cos(CoffeeGL.degToRad(meanCentre));y=Math.sin(CoffeeGL.degToRad(meanCentre));offset=new CoffeeGL.Vec2(x,y);offset.multScalar(l);this.state.mercuryDeferentPosition=this.state.deferentPosition.copy();this.state.mercuryDeferentPosition.multScalar(2);this.state.mercuryDeferentPosition.add(offset);md=CoffeeGL.Vec2.normalize(this.state.mercuryDeferentPosition);xa=new CoffeeGL.Vec2(1,0);da=CoffeeGL.radToDeg(Math.acos(md.dot(xa)));if(da<0){da=360+da}this.state.mercuryDeferentAngle=da;cr=Math.cos(CoffeeGL.degToRad(da));sr=Math.sin(CoffeeGL.degToRad(da));base_position=new CoffeeGL.Vec2(this.base_radius*cr,this.base_radius*sr);this.state.basePosition=base_position;return this.state.mercuryDeferentPosition}else if((_ref1=this.state.planet)==="moon"||_ref1==="moon_latitude"){cr=Math.cos(CoffeeGL.degToRad(this.state.deferentAngle));sr=Math.sin(CoffeeGL.degToRad(this.state.deferentAngle));x=this.moon_radius*cr;y=this.moon_radius*sr;this.state.deferentPosition=new CoffeeGL.Vec2(x,y);this.state.basePosition=new CoffeeGL.Vec2(this.base_radius*cr,this.base_radius*sr)}return this};EquatorieSystem.prototype._calculateEquantPosition=function(){var l,tm,x,y,_ref,_ref1;if((_ref=this.state.planet)==="mars"||_ref==="venus"||_ref==="jupiter"||_ref==="saturn"){this.state.equantPosition=new CoffeeGL.Vec2(this.state.deferentPosition.x*2,this.state.deferentPosition.y*2);return this.state.equantPosition}else if(this.state.planet==="mercury"){x=this.inch_to_base*34*this.planet_data[this.state.planet].deferent_eccentricity*Math.cos(CoffeeGL.degToRad(this.state.deferentAngle));y=this.inch_to_base*34*this.planet_data[this.state.planet].deferent_eccentricity*Math.sin(CoffeeGL.degToRad(this.state.deferentAngle));this.state.equantPosition=new CoffeeGL.Vec2(x,y)}else if((_ref1=this.state.planet)==="moon"||_ref1==="moon_latitude"){tm=new CoffeeGL.Matrix2([-1,0,0,-1]);this.state.equantPosition=new CoffeeGL.Vec2(this.state.deferentPosition.x,this.state.deferentPosition.y);tm.multVec(this.state.equantPosition)}else if(this.state.planet==="sun"){l=this.inch_to_base*34*this.planet_data["sun"].equant_ratio;x=Math.cos(CoffeeGL.degToRad(-this.planet_data["sun"].apogee_longitude));y=Math.sin(CoffeeGL.degToRad(-this.planet_data["sun"].apogee_longitude));this.state.equantPosition=new CoffeeGL.Vec2(x,y);this.state.equantPosition.multScalar(l)}return this};EquatorieSystem.prototype._calculateMeanMotusBody=function(body){var mean_motus_angle,mean_motus_position,passed;passed=this.state.passed;mean_motus_angle=(this.planet_data[body].mean_longitude+this.planet_data[body].deferent_speed*passed)%360*-1;mean_motus_position=new CoffeeGL.Vec2(this.base_radius*Math.cos(CoffeeGL.degToRad(mean_motus_angle)),this.base_radius*Math.sin(CoffeeGL.degToRad(mean_motus_angle)));return[mean_motus_angle,mean_motus_position]};EquatorieSystem.prototype._calculateMeanMotus=function(){var mean_motus_angle,mean_motus_position,_ref;_ref=this._calculateMeanMotusBody(this.state.planet),mean_motus_angle=_ref[0],mean_motus_position=_ref[1];this.state.meanMotusPosition=mean_motus_position;return this.state.meanMotus=mean_motus_angle};EquatorieSystem.prototype.rayCircleIntersection=function(ray_start,ray_dir,circle_centre,circle_radius){var a,b,c,d2,discriminant,f,r,t,t1,t2,v;f=CoffeeGL.Vec2.sub(ray_start,circle_centre);r=circle_radius;a=ray_dir.dot(ray_dir);b=2*f.dot(ray_dir);c=f.dot(f)-r*r;v=new CoffeeGL.Vec2;discriminant=b*b-4*a*c;if(discriminant!==0){discriminant=Math.sqrt(discriminant);t1=(-b-discriminant)/(2*a);t2=(-b+discriminant)/(2*a);t=t2;if(t2<0){t=t1}v.copyFrom(ray_start);d2=CoffeeGL.Vec2.multScalar(ray_dir,t);v.add(d2)}return v};EquatorieSystem.prototype._calculateParallel=function(){var deferent_position,dir,equant_position,passed;passed=this.state.passed;deferent_position=this.state.deferentPosition;if(this.state.planet==="mercury"){deferent_position=this.state.mercuryDeferentPosition}if(this.state.planet==="sun"){deferent_position=this.state.equantPosition}equant_position=this.state.equantPosition;dir=this.state.meanMotusPosition.copy();dir.normalize();this.state.parallelPosition=this.rayCircleIntersection(equant_position,dir,deferent_position,this.base_radius);return this.state.parallelPosition};EquatorieSystem.prototype._calculateSunCrossingPoint=function(){var dir;dir=CoffeeGL.Vec2.sub(this.state.parallelPosition,this.state.equantPosition);dir.normalize();this.state.sunCirclePoint=this.rayCircleIntersection(this.state.equantPosition,dir,this.state.equantPosition,32*this.inch_to_base);return this};EquatorieSystem.prototype._calculateMoonEquations=function(){var a,b,e,l,p,s,x,x2,y,y2;a=this.state.equantPosition.copy().normalize();b=this.state.epicyclePosition.copy().normalize();this.state.moonEquationCentre=CoffeeGL.radToDeg(Math.acos(a.dot(b)));this.state.moonTrueMotus=this.state.meanMotus+this.state.moonEquationCentre;this.state.caputDraconisMotus=(this.planet_data["caput_draconis"].start_motus+this.state.passed*this.planet_data["caput_draconis"].speed)%360;p=this.state.moonTrueMotus;if(p<0){p=360+p}l=Math.abs(p-this.state.caputDraconisMotus);if(l>180){l=l-180}this.state.moonLatitudeDegree=l;x=Math.cos(CoffeeGL.degToRad(-this.state.moonLatitudeDegree));y=Math.sin(CoffeeGL.degToRad(-this.state.moonLatitudeDegree));s=new CoffeeGL.Vec2(x,y);s.multScalar(this.base_radius);x2=Math.cos(CoffeeGL.degToRad(this.state.moonLatitudeDegree-180));y2=Math.sin(CoffeeGL.degToRad(this.state.moonLatitudeDegree-180));e=new CoffeeGL.Vec2(x2,y2);e.multScalar(this.base_radius);this.state.moonLatitudeLeft=s;this.state.moonLatitudeRight=e;return this};EquatorieSystem.prototype._calculateEpicyclePosition=function(){var dangle,deferent_position,edir,equant_position,f0,f1,fangle,l,passed,_ref,_ref1;passed=this.state.passed;dangle=this.state.deferentAngle;if(this.state.planet==="mercury"){dangle=this.state.mercuryDeferentAngle}deferent_position=this.state.deferentPosition;if(this.state.planet==="mercury"){deferent_position=this.state.mercuryDeferentPosition}equant_position=this.state.equantPosition;l=deferent_position.length()+this.epicycle_radius-this.epicycle_thickness;this.state.epicyclePrePosition=CoffeeGL.Vec2.normalize(deferent_position).multScalar(l);fangle=0;if((_ref=this.state.planet)==="mercury"||_ref==="venus"||_ref==="mars"||_ref==="jupiter"||_ref==="saturn"){edir=CoffeeGL.Vec2.sub(this.state.parallelPosition,this.state.equantPosition);edir.normalize();this.state.epicyclePosition=this.rayCircleIntersection(this.state.equantPosition,edir,this.state.deferentPosition,this.base_radius-this.epicycle_thickness);f0=CoffeeGL.radToDeg(Math.atan2(this.state.basePosition.y-deferent_position.y,this.state.basePosition.x-deferent_position.x));f1=CoffeeGL.radToDeg(Math.atan2(this.state.epicyclePosition.y-deferent_position.y,this.state.epicyclePosition.x-deferent_position.x));fangle=f0-f1;this.state.epicycleRotation=fangle;return this.state.epicyclePosition}else if((_ref1=this.state.planet)==="moon"||_ref1==="moon_latitude"){edir=this.state.meanMotusPosition.copy();edir.normalize();this.state.epicyclePosition=this.rayCircleIntersection(new CoffeeGL.Vec2(0,0),edir,this.state.deferentPosition,this.base_radius-this.epicycle_thickness);f0=CoffeeGL.radToDeg(Math.atan2(this.state.basePosition.y-deferent_position.y,this.state.basePosition.x-deferent_position.x));f1=CoffeeGL.radToDeg(Math.atan2(this.state.epicyclePosition.y-deferent_position.y,this.state.epicyclePosition.x-deferent_position.x));fangle=f0-f1;this.state.epicycleRotation=fangle;return this.state.epicyclePosition}};EquatorieSystem.prototype._calculatePointerAngle=function(){var a,angle,b,c,deferent_position,passed,_ref,_ref1;passed=this.state.passed;angle=(this.planet_data[this.state.planet].mean_anomaly+this.planet_data[this.state.planet].epicycle_speed*passed)%360*-1;if((_ref=this.state.planet)==="mercury"||_ref==="venus"||_ref==="mars"||_ref==="jupiter"||_ref==="saturn"){deferent_position=this.state.deferentPosition;if(this.state.planet==="mercury"){deferent_position=this.state.mercuryDeferentPosition}a=this.state.equantPosition.dist(this.state.epicyclePosition);b=deferent_position.dist(this.state.epicyclePosition);c=this.state.equantPosition.dist(deferent_position);this.state.meanAux=90-CoffeeGL.radToDeg(Math.acos((a*a+b*b-c*c)/(2*a*b)));this.state.pointerAngle=-angle}else if((_ref1=this.state.planet)==="moon"||_ref1==="moon_latitude"){deferent_position=this.state.deferentPosition;a=this.state.epicyclePosition.length();b=deferent_position.dist(this.state.epicyclePosition);c=deferent_position.length();this.state.meanAux=90-CoffeeGL.radToDeg(Math.acos((a*a+b*b-c*c)/(2*a*b)));this.state.pointerAngle=angle}return angle};EquatorieSystem.prototype._calculatePointerPoint=function(){var angle,ca,deferent_position,dir,epipos,perp,sa;angle=this.state.pointerAngle+this.state.meanAux;epipos=this.state.epicyclePosition;deferent_position=this.state.deferentPosition;if(this.state.planet==="mercury"){deferent_position=this.state.mercuryDeferentPosition}dir=CoffeeGL.Vec2.normalize(CoffeeGL.Vec2.sub(this.state.epicyclePosition,deferent_position));perp=dir.copy();perp.x=-dir.y;perp.y=dir.x;perp.multScalar(this.base_radius*this.planet_data[this.state.planet].epicycle_ratio);ca=Math.cos(CoffeeGL.degToRad(-angle));sa=Math.sin(CoffeeGL.degToRad(-angle));perp=new CoffeeGL.Vec2(perp.x*ca-perp.y*sa,perp.x*sa+perp.y*ca);perp.add(this.state.epicyclePosition);this.state.pointerPoint=perp;return perp};EquatorieSystem.prototype._calculateTruePlace=function(){var angle,dir,pp,xaxis,_ref;if((_ref=this.state.planet)==="mercury"||_ref==="venus"||_ref==="mars"||_ref==="jupiter"||_ref==="saturn"){pp=this.state.pointerPoint;dir=CoffeeGL.Vec2.normalize(pp);xaxis=new CoffeeGL.Vec2(1,0);angle=CoffeeGL.radToDeg(Math.acos(xaxis.dot(dir)));this.state.truePlace=angle;return angle}};return EquatorieSystem}();module.exports={EquatorieSystem:EquatorieSystem}}).call(this)},{}],3:[function(require,module,exports){(function(){var EquatorieString,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};EquatorieString=function(_super){__extends(EquatorieString,_super);function EquatorieString(length,thickness,segments){var geom,i,vert,_i,_j,_len,_ref,_ref1;this.length=length;this.thickness=thickness;this.segments=segments;EquatorieString.__super__.constructor.call(this);geom=new CoffeeGL.Shapes.Cylinder(this.thickness,24,this.segments,this.length);_ref=geom.v;for(_i=0,_len=_ref.length;_i<_len;_i++){vert=_ref[_i];vert.p.y=0}this.add(geom);this.matrices=[];for(i=_j=0,_ref1=this.segments;0<=_ref1?_j<=_ref1:_j>=_ref1;i=0<=_ref1?++_j:--_j){this.matrices.push(new CoffeeGL.Matrix4)}}EquatorieString.prototype.update=function(data){var i,phys,tmatrix,tq,_i,_ref,_results;_results=[];for(i=_i=0,_ref=this.segments;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i){phys=data.segments[i];this.matrices[i].identity();tq=new CoffeeGL.Quaternion(new CoffeeGL.Vec3(phys.q[0],phys.q[1],phys.q[2]),phys.q[3]);tmatrix=tq.getMatrix4();tmatrix.setPos(new CoffeeGL.Vec3(phys.x,phys.y,phys.z));_results.push(this.matrices[i].copyFrom(tmatrix))}return _results};return EquatorieString}(CoffeeGL.Node);module.exports={EquatorieString:EquatorieString}}).call(this)},{}],4:[function(require,module,exports){(function(){var LoadItem,LoadQueue,loadAssets,_loadAniso,_loadBackingShader,_loadBaseNormal,_loadBasic,_loadEpicycleNormal,_loadFXAAShader,_loadLighting,_loadModel,_loadPicking,_loadPlateNormal,_loadPointerNormal,_loadRimNormal,_loadStringShader;LoadItem=function(){function LoadItem(func,userOnLoaded){this.func=func;this.userOnLoaded=userOnLoaded}LoadItem.prototype.loaded=function(){this.loader.itemCompleted(this);if(this.userOnLoaded!=null){return this.userOnLoaded()}};return LoadItem}();LoadQueue=function(){function LoadQueue(obj,onLoaded,onFinish){this.obj=obj;this.onLoaded=onLoaded;this.onFinish=onFinish;this.items=[];this.completed_items=[];this.complete=new CoffeeGL.Signal;if(this.onFinish!=null){this.complete.add(onFinish,this)}}LoadQueue.prototype.itemCompleted=function(item){this.completed_items.push(item);if(this.onLoaded!=null){this.onLoaded()}if(this.completed_items.length===this.items.length){return this.complete.dispatch()}};LoadQueue.prototype.add=function(item){item.obj=this.obj;item.loader=this;return this.items.push(item)};LoadQueue.prototype.start=function(){var item,_i,_len,_ref,_results;_ref=this.items;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){item=_ref[_i];_results.push(item.func())}return _results};return LoadQueue}();_loadLighting=new LoadItem(function(){var r,_this=this;r=new CoffeeGL.Request("../shaders/basic_lighting.glsl");r.get(function(data){_this.obj.shader=new CoffeeGL.Shader(data,{uAmbientLightingColor:"uAmbientLightingColor"});return _this.loaded()});return this});_loadAniso=new LoadItem(function(){var r,_this=this;r=new CoffeeGL.Request("../shaders/anisotropic.glsl");r.get(function(data){_this.obj.shader_aniso=new CoffeeGL.Shader(data,{uAmbientLightingColor:"uAmbientLightingColor",uSpecColour:"uSpecColour",uSamplerNormal:"uSamplerNormal",uAlphaX:"uAlphaX",uAlphaY:"uAlphaY"});return _this.loaded()});return this});_loadModel=new LoadItem(function(){var r,_this=this;r=new CoffeeGL.Request("../models/equatorie.js");r.get(function(data){_this.obj.equatorie_model=new CoffeeGL.JSONModel(data,{onLoad:function(){return _this.loaded()}});return _this});return this});_loadBasic=new LoadItem(function(){var r,_this=this;r=new CoffeeGL.Request("../shaders/basic.glsl");r.get(function(data){_this.obj.shader_basic=new CoffeeGL.Shader(data,{uColour:"uColour"});return _this.loaded()});return this});_loadPicking=new LoadItem(function(){var r,_this=this;r=new CoffeeGL.Request("../shaders/picking.glsl");r.get(function(data){_this.obj.shader_picker=new CoffeeGL.Shader(data,{uPickingColour:"uPickingColour"});return _this.loaded()});return this});_loadStringShader=new LoadItem(function(){var r,_this=this;r=new CoffeeGL.Request("../shaders/string.glsl");r.get(function(data){_this.obj.shader_string=new CoffeeGL.Shader(data,{uMatrices:"matrices",uNumSegments:"segments"});return _this.loaded()});return this});_loadEpicycleNormal=new LoadItem(function(){var _this=this;this.obj.epicycle_normal=new CoffeeGL.Texture("../models/epicycle_NRM.jpg",{unit:1},function(){return _this.loaded()});return this});_loadPlateNormal=new LoadItem(function(){var _this=this;this.obj.plate_normal=new CoffeeGL.Texture("../models/plate_NRM.jpg",{unit:1},function(){return _this.loaded()});return this});_loadRimNormal=new LoadItem(function(){var _this=this;this.obj.rim_normal=new CoffeeGL.Texture("../models/ring_NRM.jpg",{unit:1},function(){return _this.loaded()});return this});_loadPointerNormal=new LoadItem(function(){var _this=this;this.obj.pointer_normal=new CoffeeGL.Texture("../models/label_NRM.jpg",{unit:1},function(){return _this.loaded()});return this});_loadBaseNormal=new LoadItem(function(){var _this=this;this.obj.base_normal=new CoffeeGL.Texture("../models/base_texture_NRM.jpg",{unit:1},function(){return _this.loaded()
});return this});_loadBackingShader=new LoadItem(function(){var r,_this=this;r=new CoffeeGL.Request("../shaders/background.glsl");r.get(function(data){_this.obj.shader_background=new CoffeeGL.Shader(data);return _this.loaded()});return this});_loadFXAAShader=new LoadItem(function(){var r,_this=this;r=new CoffeeGL.Request("../shaders/fxaa.glsl");r.get(function(data){_this.obj.shader_fxaa=new CoffeeGL.Shader(data,{uViewportSize:"viewportSize"});return _this.loaded()});return this});loadAssets=function(obj,signal,signal_progress){var a,b,lq;a=function(){return signal_progress.dispatch(this.completed_items.length/this.items.length)};b=function(){return signal.dispatch()};lq=new LoadQueue(obj,a,b);lq.add(_loadLighting);lq.add(_loadModel);lq.add(_loadBasic);lq.add(_loadPicking);lq.add(_loadAniso);lq.add(_loadEpicycleNormal);lq.add(_loadPlateNormal);lq.add(_loadRimNormal);lq.add(_loadPointerNormal);lq.add(_loadBaseNormal);lq.add(_loadBackingShader);lq.add(_loadStringShader);lq.add(_loadFXAAShader);lq.start();return this};module.exports={loadAssets:loadAssets}}).call(this)},{}],5:[function(require,module,exports){(function(){var EquatorieInteract,EquatorieState,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};EquatorieState=function(){function EquatorieState(_activate,func,duration){this._activate=_activate;this.func=func;this.duration=duration!=null?duration:3;if(this.duration==null){this.duration=3}}EquatorieState.prototype.update=function(dt){return this.func(dt)};EquatorieState.prototype.activate=function(){if(this._activate!=null){return this._activate()}};return EquatorieState}();EquatorieInteract=function(){function EquatorieInteract(system,physics,camera,white_start,white_end,black_start,black_end,epicycle,pointer,marker,string_height){this.system=system;this.physics=physics;this.camera=camera;this.white_start=white_start;this.white_end=white_end;this.black_start=black_start;this.black_end=black_end;this.epicycle=epicycle;this.pointer=pointer;this.marker=marker;this.string_height=string_height;this._stateMoveBlackStringLatitude=__bind(this._stateMoveBlackStringLatitude,this);this._stateMoveBlackStringLatitudeInit=__bind(this._stateMoveBlackStringLatitudeInit,this);this._stateMoveBlackStringFinal=__bind(this._stateMoveBlackStringFinal,this);this._stateMoveBlackStringFinalInit=__bind(this._stateMoveBlackStringFinalInit,this);this._stateRotateLabel=__bind(this._stateRotateLabel,this);this._stateRotateLabelInit=__bind(this._stateRotateLabelInit,this);this._stateRotateMeanAux=__bind(this._stateRotateMeanAux,this);this._stateRotateMeanAuxInit=__bind(this._stateRotateMeanAuxInit,this);this._stateRotateEpicycle=__bind(this._stateRotateEpicycle,this);this._stateRotateEpicycleInit=__bind(this._stateRotateEpicycleInit,this);this._stateMoveEpicycle=__bind(this._stateMoveEpicycle,this);this._stateMoveEpicycleInit=__bind(this._stateMoveEpicycleInit,this);this._stateMoveBlackThreadSun=__bind(this._stateMoveBlackThreadSun,this);this._stateMoveBlackThreadSunInit=__bind(this._stateMoveBlackThreadSunInit,this);this._stateMoveWhiteThreadSun=__bind(this._stateMoveWhiteThreadSun,this);this._stateMoveWhiteThreadSunInit=__bind(this._stateMoveWhiteThreadSunInit,this);this._stateMoveWhiteThreadMoon=__bind(this._stateMoveWhiteThreadMoon,this);this._stateMoveWhiteThreadMoonInit=__bind(this._stateMoveWhiteThreadMoonInit,this);this._stateMoveWhiteThread=__bind(this._stateMoveWhiteThread,this);this._stateMoveWhiteThreadInit=__bind(this._stateMoveWhiteThreadInit,this);this._stateMoveBlackThread=__bind(this._stateMoveBlackThread,this);this._stateMoveBlackThreadInit=__bind(this._stateMoveBlackThreadInit,this);this._stateCalculateMeanMotus=__bind(this._stateCalculateMeanMotus,this);this._stateCalculateMeanMotusInit=__bind(this._stateCalculateMeanMotusInit,this);this._stateSetPlanetDate=__bind(this._stateSetPlanetDate,this);this._stateSetPlanetDateInit=__bind(this._stateSetPlanetDateInit,this);this.mp=new CoffeeGL.Vec2(-1,-1);this.mpp=new CoffeeGL.Vec2(-1,-1);this.mpd=new CoffeeGL.Vec2(0,0);this.picked=false;this.picked_item=void 0;this.dragging=false;this.advance_date=0;this.move_poi=new CoffeeGL.Signal;if(typeof window!=="undefined"&&window!==null){window.EquatorieMovePOI=this.move_poi}this.stack=[];this.stack_idx=0;this.time={start:0,dt:0}}EquatorieInteract.prototype.update=function(dt){var da;if(this.stack.length>0){if(this.time.dt/1e3>this.stack[this.stack_idx].duration){this.stack[this.stack_idx].update(1);return}else if(this.time.dt<0){this.stack[this.stack_idx].update(0);return}else{da=this.time.dt/1e3/this.stack[this.stack_idx].duration;this.stack[this.stack_idx].update(da);this.time.dt+=dt}}return this.time.start=(new Date).getTime()};EquatorieInteract.prototype._setPOI=function(node){var i0,i1,i2,vt;i0=node.matrix;i1=this.camera.m;i2=this.camera.p.copy();vt=new CoffeeGL.Vec3(0,0,.1);i2.mult(i1).mult(i0);i2.multVec(vt);return new CoffeeGL.Vec2((vt.x+1)/2*CoffeeGL.Context.width,CoffeeGL.Context.height-(vt.y+1)/2*CoffeeGL.Context.height)};EquatorieInteract.prototype._stateSetPlanetDateInit=function(){var current_state;current_state=this.stack[this.stack_idx];current_state.text="Set the planet you are looking for and work out the number of days passed since 1392";current_state.pos=this._setPOI(this.epicycle);return this};EquatorieInteract.prototype._stateSetPlanetDate=function(planet,date){this.system.solveForPlanetDate(planet,date);return this};EquatorieInteract.prototype._stateCalculateMeanMotusInit=function(){var current_state;current_state=this.stack[this.stack_idx];current_state.text="Find the mean motus for the body in question.";if(this.chosen_planet==="moon_latitude"){current_state.text="Subract the true motus of Caput Draconis from the Moon's true motus."}current_state.pos=this._setPOI(this.epicycle);return this};EquatorieInteract.prototype._stateCalculateMeanMotus=function(dt){var current_state;current_state=this.stack[this.stack_idx];current_state.pos=this._setPOI(this.epicycle);this.move_poi.dispatch(current_state.pos);return this};EquatorieInteract.prototype._stateMoveBlackThreadInit=function(){var current_state,mv;current_state=this.stack[this.stack_idx];current_state.text="Move the black thread so it runs from the Earth to the Mean Motus";current_state.pos=this._setPOI(this.black_end);mv=this.system.state.meanMotusPosition.copy();mv.normalize();mv.multScalar(10);current_state.end_interp=new CoffeeGL.Interpolation(this.black_end.matrix.getPos(),new CoffeeGL.Vec3(mv.x,this.string_height,mv.y));return current_state.start_interp=new CoffeeGL.Interpolation(this.black_start.matrix.getPos(),new CoffeeGL.Vec3(0,this.string_height,0))};EquatorieInteract.prototype._stateMoveBlackThread=function(dt){var current_state;current_state=this.stack[this.stack_idx];this.black_start.matrix.setPos(current_state.start_interp.set(dt));this.black_end.matrix.setPos(current_state.end_interp.set(dt));this.physics.postMessage({cmd:"black_start_move",data:this.black_start.matrix.getPos()});this.physics.postMessage({cmd:"black_end_move",data:this.black_end.matrix.getPos()});current_state.pos=this._setPOI(this.black_end);this.move_poi.dispatch(current_state.pos);return this};EquatorieInteract.prototype._stateMoveWhiteThreadInit=function(){var current_state,eq,pv;current_state=this.stack[this.stack_idx];current_state.text="Move the white thread so it runs from the Equant, parallel to the black thread";eq=this.system.state.equantPosition;pv=this.system.state.parallelPosition;pv.sub(eq);pv.normalize();pv.multScalar(10);pv.add(eq);current_state.end_interp=new CoffeeGL.Interpolation(this.white_end.matrix.getPos(),new CoffeeGL.Vec3(pv.x,this.string_height,pv.y));eq=this.system.state.equantPosition;return current_state.start_interp=new CoffeeGL.Interpolation(this.white_start.matrix.getPos(),new CoffeeGL.Vec3(eq.x,this.string_height,eq.y))};EquatorieInteract.prototype._stateMoveWhiteThread=function(dt){var current_state;current_state=this.stack[this.stack_idx];this.white_start.matrix.setPos(current_state.start_interp.set(dt));this.white_end.matrix.setPos(current_state.end_interp.set(dt));this.physics.postMessage({cmd:"white_start_move",data:this.white_start.matrix.getPos()});this.physics.postMessage({cmd:"white_end_move",data:this.white_end.matrix.getPos()});current_state.pos=this._setPOI(this.white_end);return this.move_poi.dispatch(current_state.pos)};EquatorieInteract.prototype._stateMoveWhiteThreadMoonInit=function(){var current_state,eq,pv;current_state=this.stack[this.stack_idx];current_state.text="Move the white thread so one end is over the equant and the other runs across the label. The equant is 180 degrees from the deferent.";pv=this.system.state.pointerPoint.copy();pv.sub(this.system.state.equantPosition);pv.normalize();pv.multScalar(10);pv.add(this.system.state.equantPosition);pv=new CoffeeGL.Vec3(pv.x,this.string_height,pv.y);current_state.end_interp=new CoffeeGL.Interpolation(this.white_end.matrix.getPos(),pv);eq=this.system.state.equantPosition;return current_state.start_interp=new CoffeeGL.Interpolation(this.white_start.matrix.getPos(),new CoffeeGL.Vec3(eq.x,this.string_height,eq.y))};EquatorieInteract.prototype._stateMoveWhiteThreadMoon=function(dt){var current_state;current_state=this.stack[this.stack_idx];this.white_start.matrix.setPos(current_state.start_interp.set(dt));this.white_end.matrix.setPos(current_state.end_interp.set(dt));this.physics.postMessage({cmd:"white_start_move",data:this.white_start.matrix.getPos()});this.physics.postMessage({cmd:"white_end_move",data:this.white_end.matrix.getPos()});current_state.pos=this._setPOI(this.white_end);this.move_poi.dispatch(current_state.pos);return this};EquatorieInteract.prototype._stateMoveWhiteThreadSunInit=function(){var current_state,ev,pv;current_state=this.stack[this.stack_idx];current_state.text="Move the white thread so it runs parallel to the black thread from the Sun's equant point.";ev=new CoffeeGL.Vec3(this.system.state.equantPosition.x,this.string_height,this.system.state.equantPosition.y);current_state.end_interp=new CoffeeGL.Interpolation(this.white_end.matrix.getPos(),ev);pv=this.system.state.parallelPosition.copy();pv.sub(this.system.state.equantPosition);pv.normalize();pv.multScalar(10);pv.add(this.system.state.equantPosition);pv=new CoffeeGL.Vec3(pv.x,this.string_height,pv.y);return current_state.start_interp=new CoffeeGL.Interpolation(this.white_start.matrix.getPos(),pv)};EquatorieInteract.prototype._stateMoveWhiteThreadSun=function(dt){var current_state;current_state=this.stack[this.stack_idx];current_state.pos=this._setPOI(this.white_end);this.move_poi.dispatch(current_state.pos);this.white_start.matrix.setPos(current_state.start_interp.set(dt));this.white_end.matrix.setPos(current_state.end_interp.set(dt));this.physics.postMessage({cmd:"white_start_move",data:this.white_start.matrix.getPos()});this.physics.postMessage({cmd:"white_end_move",data:this.white_end.matrix.getPos()});return this};EquatorieInteract.prototype._stateMoveBlackThreadSunInit=function(){var current_state,pv;current_state=this.stack[this.stack_idx];current_state.text="Move the black thread so it crosses the white thread at the Sun's eccentric circle.";pv=this.system.state.sunCirclePoint.copy();pv.normalize();pv.multScalar(10);pv=new CoffeeGL.Vec3(pv.x,this.string_height,pv.y);return current_state.end_interp=new CoffeeGL.Interpolation(this.white_start.matrix.getPos(),pv)};EquatorieInteract.prototype._stateMoveBlackThreadSun=function(dt){var current_state;current_state=this.stack[this.stack_idx];this.black_end.matrix.setPos(current_state.end_interp.set(dt));current_state.pos=this._setPOI(this.black_end);this.move_poi.dispatch(current_state.pos);this.physics.postMessage({cmd:"black_end_move",data:this.black_end.matrix.getPos()});return this};EquatorieInteract.prototype._stateMoveEpicycleInit=function(){var c,current_state,d,dr,e,v;current_state=this.stack[this.stack_idx];current_state.text="Move the epicycle so its common centre deferent is over the deferent point.";if(this.chosen_planet==="moon"){current_state.text+=" The Moon has a moving deferent centre."}d=this.system.state.deferentPosition;c=this.system.state.basePosition;v=this.system.state.parallelPosition;dr=this.system.state.deferentAngle;if(this.chosen_planet==="mercury"){dr=this.system.state.mercuryDeferentAngle}e=this.system.state.epicyclePrePosition;current_state.pos_interp=new CoffeeGL.Interpolation(this.epicycle.matrix.getPos(),new CoffeeGL.Vec3(e.x,0,e.y));return current_state.rot_interp=new CoffeeGL.Interpolation(0,-90-dr)};EquatorieInteract.prototype._stateMoveEpicycle=function(dt){var current_state,_ref;current_state=this.stack[this.stack_idx];this.epicycle.matrix.identity();this.epicycle.matrix.translate(current_state.pos_interp.set(dt));this.epicycle.matrix.rotate(new CoffeeGL.Vec3(0,1,0),CoffeeGL.degToRad(current_state.rot_interp.set(dt)));this.marker.matrix.identity();if(this.chosen_planet==="mercury"){this.marker.matrix.translate(new CoffeeGL.Vec3(this.system.state.mercuryDeferentPosition.x,.4,this.system.state.mercuryDeferentPosition.y))}else if((_ref=this.chosen_planet)==="mars"||_ref==="venus"||_ref==="jupiter"||_ref==="saturn"||_ref==="moon"){this.marker.matrix.translate(new CoffeeGL.Vec3(this.system.state.deferentPosition.x,.4,this.system.state.deferentPosition.y))}current_state.pos=this._setPOI(this.marker);this.move_poi.dispatch(current_state.pos);return this};EquatorieInteract.prototype._stateRotateEpicycleInit=function(){var current_state;current_state=this.stack[this.stack_idx];current_state.text="Rotate the epicycle until it's centre is over the white string";if(this.chosen_planet==="moon"){current_state.text="Rotate the epicycle until it's centre is over the black string"}return current_state.rot_interp=new CoffeeGL.Interpolation(0,this.system.state.epicycleRotation)};EquatorieInteract.prototype._stateRotateEpicycle=function(dt){var cp,current_state,deferentAngle,fmatrix,tmatrix,v1,v2;current_state=this.stack[this.stack_idx];v1=this.system.state.deferentPosition;if(this.chosen_planet==="mercury"){v1=this.system.state.mercuryDeferentPosition}v2=CoffeeGL.Vec2.sub(this.system.state.epicyclePrePosition,v1);tmatrix=new CoffeeGL.Matrix4;fmatrix=new CoffeeGL.Matrix4;deferentAngle=this.system.state.deferentAngle;if(this.chosen_planet==="mercury"){deferentAngle=this.system.state.mercuryDeferentAngle}tmatrix.translate(new CoffeeGL.Vec3(v2.x,0,v2.y));tmatrix.rotate(new CoffeeGL.Vec3(0,1,0),CoffeeGL.degToRad(-90-deferentAngle));fmatrix.translate(new CoffeeGL.Vec3(v1.x,0,v1.y));fmatrix.rotate(new CoffeeGL.Vec3(0,1,0),CoffeeGL.degToRad(current_state.rot_interp.set(dt)));this.epicycle.matrix.copyFrom(fmatrix.mult(tmatrix));cp=this.system.state.epicyclePosition;this.marker.matrix.identity();this.marker.matrix.translate(new CoffeeGL.Vec3(cp.x,0,cp.y));current_state.pos=this._setPOI(this.epicycle);this.move_poi.dispatch(current_state.pos);return this};EquatorieInteract.prototype._stateRotateMeanAuxInit=function(){var current_state;current_state=this.stack[this.stack_idx];current_state.text="Rotate the label till it is aligned with the white string.";if(this.chosen_planet==="moon"){current_state.text="Rotate the label till it is aligned with the black string."}return current_state.rot_interp=new CoffeeGL.Interpolation(0,this.system.state.meanAux)};EquatorieInteract.prototype._stateRotateMeanAux=function(dt){var current_state;current_state=this.stack[this.stack_idx];this.pointer.matrix.identity();this.pointer.matrix.rotate(new CoffeeGL.Vec3(0,1,0),CoffeeGL.degToRad(current_state.rot_interp.set(dt)));current_state.pos=this._setPOI(this.epicycle);this.move_poi.dispatch(current_state.pos);return this};EquatorieInteract.prototype._stateRotateLabelInit=function(){var current_state;current_state=this.stack[this.stack_idx];current_state.text="Rotate the label by the Mean Argument";return current_state.rot_interp=new CoffeeGL.Interpolation(0,this.system.state.pointerAngle)};EquatorieInteract.prototype._stateRotateLabel=function(dt){var cp,current_state;current_state=this.stack[this.stack_idx];this.pointer.matrix.identity();this.pointer.matrix.rotate(new CoffeeGL.Vec3(0,1,0),CoffeeGL.degToRad(this.system.state.meanAux+current_state.rot_interp.set(dt)));cp=this.system.state.pointerPoint;this.marker.matrix.identity();this.marker.matrix.translate(new CoffeeGL.Vec3(cp.x,.6,cp.y));current_state.pos=this._setPOI(this.marker);this.move_poi.dispatch(current_state.pos);return this};EquatorieInteract.prototype._stateMoveBlackStringFinalInit=function(){var current_state,mv;current_state=this.stack[this.stack_idx];current_state.text="Move the black string till it meets the point on the label. Read off the true place where the string crosses the limb";mv=new CoffeeGL.Vec3(this.system.state.pointerPoint.x,0,this.system.state.pointerPoint.y);mv.normalize();mv.multScalar(10);mv.y=this.string_height;return current_state.end_interp=new CoffeeGL.Interpolation(this.black_end.matrix.getPos(),mv)};EquatorieInteract.prototype._stateMoveBlackStringFinal=function(dt){var current_state;current_state=this.stack[this.stack_idx];this.black_end.matrix.setPos(current_state.end_interp.set(dt));this.physics.postMessage({cmd:"black_end_move",data:this.black_end.matrix.getPos()});current_state.pos=this._setPOI(this.black_end);this.move_poi.dispatch(current_state.pos);return this};EquatorieInteract.prototype._stateMoveBlackStringLatitudeInit=function(){var current_state,e,l,s;current_state=this.stack[this.stack_idx];current_state.text="Move the black string so it is perpendicular to the Alhudda line and cutting the rim at the spot marked by the previous value.";s=new CoffeeGL.Vec3(this.system.state.moonLatitudeLeft.x,0,this.system.state.moonLatitudeLeft.y);e=new CoffeeGL.Vec3(this.system.state.moonLatitudeRight.x,0,this.system.state.moonLatitudeRight.y);l=s.dist(e);s.x=s.x-(6-l/2);e.x=e.x+(6-l/2);s.y=this.string_height;e.y=this.string_height;current_state.start_interp=new CoffeeGL.Interpolation(this.black_start.matrix.getPos(),s);return current_state.end_interp=new CoffeeGL.Interpolation(this.black_end.matrix.getPos(),e)};EquatorieInteract.prototype._stateMoveBlackStringLatitude=function(dt){var current_state;current_state=this.stack[this.stack_idx];this.black_start.matrix.setPos(current_state.start_interp.set(dt));this.black_end.matrix.setPos(current_state.end_interp.set(dt));current_state.pos=this._setPOI(this.black_end);this.move_poi.dispatch(current_state.pos);this.physics.postMessage({cmd:"black_start_move",data:this.black_start.matrix.getPos()});this.physics.postMessage({cmd:"black_end_move",data:this.black_end.matrix.getPos()});return this};EquatorieInteract.prototype.addStates=function(planet,date){var _this=this;this.stack=[];this.stack.push(new EquatorieState(this._stateSetPlanetDateInit,function(){return function(planet,date){return _this._stateSetPlanetDate(planet,date)}(planet,date)}));if(planet==="mars"||planet==="venus"||planet==="jupiter"||planet==="saturn"||planet==="mercury"){this.stack.push(new EquatorieState(this._stateCalculateMeanMotusInit,this._stateCalculateMeanMotus));this.stack.push(new EquatorieState(this._stateMoveBlackThreadInit,this._stateMoveBlackThread));this.stack.push(new EquatorieState(this._stateMoveWhiteThreadInit,this._stateMoveWhiteThread));this.stack.push(new EquatorieState(this._stateMoveEpicycleInit,this._stateMoveEpicycle));this.stack.push(new EquatorieState(this._stateRotateEpicycleInit,this._stateRotateEpicycle));this.stack.push(new EquatorieState(this._stateRotateMeanAuxInit,this._stateRotateMeanAux));this.stack.push(new EquatorieState(this._stateRotateLabelInit,this._stateRotateLabel));return this.stack.push(new EquatorieState(this._stateMoveBlackStringFinalInit,this._stateMoveBlackStringFinal))}else if(planet==="moon"){this.stack.push(new EquatorieState(this._stateCalculateMeanMotusInit,this._stateCalculateMeanMotus));this.stack.push(new EquatorieState(this._stateMoveBlackThreadInit,this._stateMoveBlackThread));this.stack.push(new EquatorieState(this._stateMoveEpicycleInit,this._stateMoveEpicycle));this.stack.push(new EquatorieState(this._stateRotateEpicycleInit,this._stateRotateEpicycle));this.stack.push(new EquatorieState(this._stateRotateMeanAuxInit,this._stateRotateMeanAux));this.stack.push(new EquatorieState(this._stateRotateLabelInit,this._stateRotateLabel));return this.stack.push(new EquatorieState(this._stateMoveWhiteThreadMoonInit,this._stateMoveWhiteThreadMoon))}else if(planet==="moon_latitude"){this.stack.push(new EquatorieState(this._stateCalculateMeanMotusInit,this._stateCalculateMeanMotus));return this.stack.push(new EquatorieState(this._stateMoveBlackStringLatitudeInit,this._stateMoveBlackStringLatitude))}else if(planet==="sun"){this.stack.push(new EquatorieState(this._stateCalculateMeanMotusInit,this._stateCalculateMeanMotus));this.stack.push(new EquatorieState(this._stateMoveBlackThreadInit,this._stateMoveBlackThread));this.stack.push(new EquatorieState(this._stateMoveWhiteThreadSunInit,this._stateMoveWhiteThreadSun));return this.stack.push(new EquatorieState(this._stateMoveBlackThreadSunInit,this._stateMoveBlackThreadSun))}};EquatorieInteract.prototype.reset=function(){this.stack=[];this.stack_idx=0;this.system.reset();this.marker.matrix.identity();this.epicycle.matrix.identity();this.pointer.matrix.identity();this.white_start.matrix.identity().translate(new CoffeeGL.Vec3(2,this.string_height,2));this.white_end.matrix.identity().translate(new CoffeeGL.Vec3(-2,this.string_height,-2));this.black_start.matrix.identity().translate(new CoffeeGL.Vec3(-2,this.string_height,2));this.black_end.matrix.identity().translate(new CoffeeGL.Vec3(-4,this.string_height,2));this.camera.pos=new CoffeeGL.Vec3(0,0,10);this.camera.look=new CoffeeGL.Vec3(0,0,0);this.camera.up=new CoffeeGL.Vec3(0,1,0);this.camera.rotateFocal(new CoffeeGL.Vec3(1,0,0),CoffeeGL.degToRad(-25));return this.physics.postMessage({cmd:"reset"})};EquatorieInteract.prototype.solveForPlanet=function(planet,date){var s,state,_i,_ref,_results;this.reset();this.addStates(planet,date);_results=[];for(s=_i=0,_ref=this.stack.length-1;0<=_ref?_i<=_ref:_i>=_ref;s=0<=_ref?++_i:--_i){this.stack_idx=s;state=this.stack[s];state.activate();_results.push(state.update(1))}return _results};EquatorieInteract.prototype.onMouseDown=function(event){this.mp.x=event.mouseX;this.mp.y=event.mouseY;this.ray=this.camera.castRay(this.mp.x,this.mp.y);this.mdown=true;if(!this.picked){return this.camera.onMouseDown(event)}else{return this.dragging=true}};EquatorieInteract.prototype.onMouseMove=function(event){var d,dd,np,p0,p1,tp,tray;this.mpp.x=this.mp.x;this.mpp.y=this.mp.y;this.mp.x=event.mouseX;this.mp.y=event.mouseY;this.mpd.x=this.mp.x-this.mpp.x;this.mpd.y=this.mp.y-this.mpp.y;if(this.dragging){tray=this.camera.castRay(this.mp.x,this.mp.y);d=CoffeeGL.rayPlaneIntersect(new CoffeeGL.Vec3(0,this.string_height,0),new CoffeeGL.Vec3(0,1,0),this.camera.pos,this.ray);dd=CoffeeGL.rayPlaneIntersect(new CoffeeGL.Vec3(0,this.string_height,0),new CoffeeGL.Vec3(0,1,0),this.camera.pos,tray);p0=tray.copy();p0.multScalar(dd);p0.add(this.camera.pos);p1=this.ray.copy();p1.multScalar(d);p1.add(this.camera.pos);p0.y=this.string_height;p1.y=this.string_height;np=CoffeeGL.Vec3.sub(p0,p1);this.ray.copyFrom(tray);if(this.picked_item!==this.pointer){tp=this.picked_item.matrix.getPos();this.picked_item.matrix.setPos(tp.add(np))}if(this.picked_item===this.white_start){return this.physics.postMessage({cmd:"white_start_move",data:this.picked_item.matrix.getPos()})}else if(this.picked_item===this.white_end){return this.physics.postMessage({cmd:"white_end_move",data:this.picked_item.matrix.getPos()})}else if(this.picked_item===this.black_start){return this.physics.postMessage({cmd:"black_start_move",data:this.picked_item.matrix.getPos()})}else if(this.picked_item===this.black_end){return this.physics.postMessage({cmd:"black_end_move",data:this.picked_item.matrix.getPos()})}}else{return this.camera.onMouseMove(event)}};EquatorieInteract.prototype.checkPicked=function(p){if(this.dragging){return}this.picked=false;if(p[0]===255&&p[1]===0&&p[2]===0){this.picked_item=this.white_start;return this.picked=true}else if(p[0]===0&&p[1]===255&&p[2]===0){this.picked_item=this.white_end;return this.picked=true}else if(p[0]===0&&p[1]===0&&p[2]===255){this.picked_item=this.black_start;return this.picked=true}else if(p[0]===255&&p[1]===255&&p[2]===255){this.picked_item=this.black_end;return this.picked=true}else if(p[0]===255&&p[1]===255&&p[2]===0){this.picked_item=this.epicycle;return this.picked=true}else if(p[0]===0&&p[1]===255&&p[2]===255){this.picked_item=this.pointer;return this.picked=true}};EquatorieInteract.prototype._initGUI=function(){var controller,planets,_this=this;this.datgui=new dat.GUI;this.datgui.remember(this);planets=["mars","venus","jupiter","saturn","mercury","moon","sun","moon_latitude"];this.chosen_planet="mars";controller=this.datgui.add(this,"chosen_planet",planets);controller=this.datgui.add(this,"solveForCurrentDatePlanet");controller=this.datgui.add(this,"advance_date",0,730);controller.onChange(function(value){return _this.solveForCurrentDatePlanet()});controller=this.datgui.add(this,"stepForward");controller=this.datgui.add(this,"reset");controller=this.datgui.add(this.pointer,"uAlphaX",0,1);controller=this.datgui.add(this.pointer,"uAlphaY",0,1);controller=this.datgui.add(this.epicycle,"uAlphaX",0,1);return controller=this.datgui.add(this.epicycle,"uAlphaY",0,1)};EquatorieInteract.prototype.solveForCurrentDatePlanet=function(){var date;date=new Date;date.setDate(this.date.getDate()+this.advance_date);return this.solveForPlanet(this.chosen_planet,date)};EquatorieInteract.prototype.stepForward=function(){var rval;this.time.start=(new Date).getTime();if(this.stack.length===0){this.addStates(this.chosen_planet,this.date);this.stack_idx=0}else{if(this.stack_idx+1<this.stack.length){this.stack[this.stack_idx].update(1);this.time.dt=0;this.stack_idx+=1}}this.stack[this.stack_idx].activate();rval={};if(this.stack[this.stack_idx].text!=null){rval.text=this.stack[this.stack_idx].text}if(this.stack[this.stack_idx].pos!=null){rval.pos=this.stack[this.stack_idx].pos}return rval};EquatorieInteract.prototype.setDate=function(date){var from;if(date==null){this.date=new Date;return this.date.setDate(this.date.getDate()+this.advance_date)}else if(date instanceof Date){return this.date=date}else{from=date.split("-");return this.date=new Date(from[2],from[1]-1,from[0])}};EquatorieInteract.prototype.onMouseOver=function(event){this.mp.x=event.mouseX;return this.mp.y=event.mouseY};EquatorieInteract.prototype.onMouseUp=function(event){this.mdown=false;this.picked=false;return this.dragging=false};EquatorieInteract.prototype.onMouseOut=function(event){this.mp.x=this.mpp.x=-1;this.mp.y=this.mpp.y=-1;this.mpd.x=this.mpd.y=0;this.mdown=false;this.picked=false;return this.dragging=false};return EquatorieInteract}();module.exports={EquatorieInteract:EquatorieInteract}}).call(this)},{}]},{},[1]);